<ng-template #ruleContainer let-rulesObj='rulesObj' let-rulesSet="rulesSet" let-rule='rule' let-ruleIndex='ruleIndex'  let-validationMode='validationMode'>
  <div class="drop-down-sec w-100 col-12 row m-0 pr-0">
    <span class="info-rule if" *ngIf="!ruleIndex">If</span>
    <div *ngIf="validationMode==='simple'" class="close-minus-btn" (click)="removeSimpleRule(rulesSet,ruleIndex)"><span></span></div>
    <div *ngIf="validationMode==='advanced'" class="close-minus-btn" (click)="removeAdvancedRule(ruleIndex,rulesSet,rule)"><span></span></div>
    <div class="col-3 add-ruleinputs">   
      <div class="kr-sg-dropdowns">                                        
        <div class="dropdown dropdown-open">
            <button class="dropdown-toggle dropdown-input" data-toggle="dropdown">{{rule.contextType?rule.contextType:'Choose Type'}}</button>                                            
            <ul class="dropdown-menu content-menu">
              <li (click)='updatedContextType(rule, conType)' *ngFor="let conType of rule.listContextTypes"><a>{{conType}}</a></li>
            </ul>
          </div>
      </div>
    </div>
    <div class="col-3 add-ruleinputs">   
      <div class="kr-sg-dropdowns">                                        
        <div class="dropdown dropdown-open">
            <button class="dropdown-toggle dropdown-input" data-toggle="dropdown">{{rule.contextCategory?rule.contextCategory:'Choose Category'}}</button>                                            
            <ul class="dropdown-menu content-menu">
              <li *ngFor="let contCate of rule.dispContextCategories" (click)='updateContextCategory(rule, contCate)'>
                <a>{{contCate}}</a>
              </li>
            </ul>
          </div>
      </div>
    </div>
    <div class="col-3 add-ruleinputs">      
      <div class="kr-sg-dropdowns">                                        
        <div class="dropdown dropdown-open">
            <button class="dropdown-toggle dropdown-input" data-toggle="dropdown">{{rule.operator?rule.operator:'Choose Operator'}}</button>                                            
            <ul class="dropdown-menu content-menu">
              <li (click)="rule.operator='Starts With'"><a>Starts With</a></li>
              <li (click)="rule.operator='Contains'"><a>Contains</a></li>
              <li (click)="rule.operator='Equals to'"><a>Equals to</a></li>
            </ul>
          </div>
      </div>
    </div>
    <div class="col-3 add-ruleinputs pr-0">                        
      <app-group-input [valuesAdded]='rule.values' [customEmitter]='true' (emitValues)="addedGroupToRule($event,rule,'if')"></app-group-input>
    </div>
</div>  
    <ng-container *ngIf="validationMode==='simple'">
    <div class="rule-info" *ngIf="ruleIndex !== (rulesSet.rules.length-1)">AND</div>
    <div class="row justify-content-between align-items-center col-12 pr-0 add-rule-plus-icon" *ngIf="ruleIndex === (rulesSet.rules.length-1)">
        <div class="close-minus-btn add-plus" (click)="addSimpleRule(rulesSet,'simple')"><span><img src="assets/icons/plus-white.svg"></span></div>
    </div>
    <div class="error-message-text-box w-100 row m-0" *ngIf="ruleIndex === (rulesSet.rules.length-1)">
        <span class="info-rule">then</span>
        <div class="kr-sg-dropdowns add-ruleinputs col-3">                                        
          <div class="dropdown dropdown-open">
              <button class="dropdown-toggle dropdown-input" data-toggle="dropdown">{{rulesObjOO.then.resultCategory?rulesObjOO.then.resultCategory:'Choose'}}</button>                                            
              <ul class="dropdown-menu content-menu">
                <li (click)='updateResCat(rulesObjOO, resCat)' *ngFor="let resCat of listResultsCategories"><a>{{resCat}}</a></li>
              </ul>
            </div>
        </div>
        <div class="kr-sg-input-text col-7 add-ruleinputs">
            <app-group-input [valuesAdded]="rulesObjOO.then.values" [customEmitter]='true' (emitValues)="addedGroupToRule($event,rule,'then')"></app-group-input>           
        </div>     
    </div>
    </ng-container>
</ng-template>

<div class="rules-table-container">
    <div class="tab-sec-top">
        <div class="d-flex">
          <!-- <div (click)='selectTab("attributes")' class="tab-name" [ngClass]="{'active': selectedTab==='attributes'}">Attributes</div> -->
          <div (click)='selectTab("rules")' class="tab-name" [ngClass]="{'active': selectedTab==='rules'}">Rules</div>
          <div  (click)='selectTab("signals")' class="tab-name" [ngClass]="{'active': selectedTab==='signals'}">Signals</div>
        </div>
        <div class="header-sec" *ngIf="rules && rules.length && !loadingRules">
            <div class="kr-sg-input-search">                               
                <input type="text" placeholder="Search" class="input-search" id="searchFaqs" name='faqsSearch' [(ngModel)]="searchBlock">
                <img src="assets/icons/search-gray.svg" class="search-icon">
            </div>
            <button class="kr-sg-button-secondary btn_lg" (click)="addEditRules()" *ngIf="selectedTab==='rules'">Add</button>
        </div>
    </div>
   <ng-container *ngIf="selectedTab==='rules'">
    <div class="faq-header-sec row m-0">
        <div class="col-12 left-sec p-0">
            <div class="tab-sec d-flex">
                <div class="tab_title" (click)="tabActive(tab)" [ngClass]="{'active': tab.isSelected}" *ngFor="let tab of tabsList">
                  {{tab.name}}
                  <span>({{tab.count || 0}})</span>
                </div>
            </div>
        </div>       
    </div>
    <div class="table-list-content" *ngIf="tabsList[0].isSelected && draftRules && draftRules.length && !loadingRules">
      <app-rules-table [rulesData]='draftRules' [searchBlock]='searchBlock'></app-rules-table>
    </div>
    <div class="table-list-content" *ngIf="tabsList[1].isSelected &&inReviewRules && inReviewRules.length && !loadingRules">
      <app-rules-table [rulesData]='inReviewRules' [searchBlock]='searchBlock'></app-rules-table>
    </div>
    <div class="table-list-content" *ngIf="tabsList[2].isSelected &&approvedRules && approvedRules.length && !loadingRules">
      <app-rules-table [rulesData]='approvedRules' [searchBlock]='searchBlock'></app-rules-table>
    </div>
    
    <div *ngIf="loadingRules" class="p-5 text-center">
      Loading....
    </div>
    <div class="empty-questions-selected" *ngIf="!(rules && rules.length) && !loadingRules">
        <img src="assets/images/icons/empty_ill.svg">
        <div class="heading">No rules added yet</div>
        <!-- <div class="desc">Please add rules</div> -->
        <button class="kr-sg-button-secondary btn_lg" (click)="addEditRules()">Add</button>
    </div>
    <div *ngIf="tabsList[0].isSelected && !(draftRules && draftRules.length) && !loadingRules" class="p-5 text-center">
      No Draft Rules
    </div>
    <div *ngIf="tabsList[1].isSelected && !(inReviewRules && inReviewRules.length) && !loadingRules" class="p-5 text-center">
      No In-review Rules
    </div>
    <div *ngIf="tabsList[2].isSelected && !(approvedRules && approvedRules.length) && !loadingRules" class="p-5 text-center">
      No Approved Rules
    </div>
   </ng-container>
   <ng-container *ngIf="selectedTab==='signals'">
    <div class="empty-questions-selected-signals">
      <img src="assets/images/icons/empty_ill.svg">
      <div class="heading">No Signals added yet</div>     
    </div>
   </ng-container>
 </div>

<kr-modal modalType="center" #addRulesModalPop modalClass="modal_popups_">
  <div class="modal-header">   
    <div class="title" *ngIf="isAdd">Add Rules</div>
    <div class="title" *ngIf="isEdit">Edit Rules</div>
    <div class="close_icon" (click)='closeAddRulesModal()'><img src="assets/icons/modal-close.svg"></div>
  </div>
  <perfect-scrollbar class="perfect-scroll-modal-body">
    <div class="modal-body">
        <div class="col-12 p-0" *ngIf="validationRules && validationRules.rules && validationRules.rules.length">
          <ng-container *ngFor="let simpleRule of validationRules.rules; index as parentIndex">
              <div class="kr-sg-input-text rule-name-input">
                <div class="label-text">Rule Name</div>
                  <input autocomplete="off" type="text" placeholder="Enter Rule Name" class="input-text" [(ngModel)]='name.na'>
              </div>
              <div class="validation-setting-rules" >
                  <ng-container *ngFor="let rule of simpleRule.rules; index as i">
                      <ng-container 
                          *ngTemplateOutlet="ruleContainer; context{$implicit: validationRules,rulesSet:simpleRule,rule:rule,ruleIndex:i,validationMode:'simple', rulesObj: validationRules.then}">
                      </ng-container>
                  </ng-container>
              </div>  
          </ng-container>
        </div>
    </div>
  </perfect-scrollbar> 
  <div class="modal-footer">
      <button class="kr-sg-button-primary btn_lg" *ngIf="isAdd" (click)="saveRules()">Add</button>
      <button class="kr-sg-button-primary btn_lg" *ngIf="isEdit" (click)="editRules()">Edit</button>
      <button class="kr-sg-button-secondary btn_lg" (click)='closeAddRulesModal()'>Cancel</button>
  </div>
</kr-modal>
