<ng-template #ruleContainer let-rulesObj='rulesObj' let-rulesSet="rulesSet" let-rule='rule' let-ruleIndex='ruleIndex'  let-validationMode='validationMode'>
    <div [ngClass]="{'validation-rules-add-edit row m-0 mt-1 mb-1 w-100 col-12': (validationMode==='simple')}">        
        <div [ngClass]="{'drop-down-sec w-100 col-12 row m-0 p-0':(validationMode==='simple'), 'd-flex mt-mb-11 w-100 rules-selection align-items-center':(validationMode==='advanced')}" class="drop-down-sec w-100 col-12 row m-0 p-0">
            <span class="info-rule if">If</span>
            <div *ngIf="validationMode==='simple'" class="close-minus-btn" (click)="removeSimpleRule(rulesSet,ruleIndex)"><span>-</span></div>
            <div *ngIf="validationMode==='advanced'" class="close-minus-btn" (click)="removeAdvancedRule(ruleIndex,rulesSet,rule)"><span>-</span></div>
            <div class="col-3">                        
                <div class="kr-sg-dropdowns">                           
                    <div class="dropdown dropdown-open" ngbDropdown>
                        <button class="dropdown-toggle dropdown-input"  ngbDropdownToggle>{{rule.contextType?rule.contextType:'Choose'}}</button>                                            
                        <ul class="dropdown-menu content-menu p-0" ngbDropdownMenu (click)="$event.stopImmediatePropagation()"> 
                        <li (click)="rule.contextType='Search Context'" >Search Context</li>  
                        <li (click)="rule.contextType='Search Context'">User Context</li>  
                        <li (click)="rule.contextType='Search Context'">Page Context</li>  
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-3">                        
                <div class="kr-sg-input-text">
                    <input type="text" [(ngModel)]="rule.contextCategory"  placeholder="" class="input-text">
                </div>
            </div>
            <div class="col-3">                        
                <div class="kr-sg-dropdowns">                           
                    <div class="dropdown dropdown-open" ngbDropdown>
                        <button class="dropdown-toggle dropdown-input"  ngbDropdownToggle>Choose </button>                                            
                        <ul class="dropdown-menu content-menu p-0" ngbDropdownMenu (click)="$event.stopImmediatePropagation()"> 
                           <li (click)="rule.operator='Starts With'">Starts With</li> 
                           <li (click)="rule.operator='Contains'">Contains</li> 
                           <li (click)="rule.operator='Equals to'">Equals to</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-3">                        
                <mat-form-field class="example-chip-list mb-15" [floatLabel]="'never'">
                    <mat-chip-list #chipList1 aria-label="tag selection">
                      <mat-chip *ngFor="let tag of rule.values; let index = index" (removed)="removeAltTag(tag)">
                         <div class="mat-value" *ngIf="tag">{{tag.value}}</div> 
                        <mat-icon matChipRemove><img src="assets/images/close.svg"></mat-icon>
                      </mat-chip>
                      <input placeholder="Type & enter" [matChipInputFor]="chipList1" [matChipInputSeparatorKeyCodes]="separatorKeysCodes" name = "tagInput"  (matChipInputTokenEnd)="addAltTag($event,rule)" id="tagInput" (click)="$event.stopPropagation()">
                    </mat-chip-list>
                  </mat-form-field> 
            </div>
        </div>        
    </div>
    <ng-container *ngIf="validationMode==='simple'">
    <div class="rule-info" *ngIf="ruleIndex !== (rulesSet.rules.length-1)">AND</div>
    <div class="row justify-content-between align-items-center col-12 pr-0 add-rule-plus-icon" *ngIf="ruleIndex === (rulesSet.rules.length-1)">
        <div class="close-minus-btn add-plus" (click)="addSimpleRule(rulesSet,'simple')"><span>+</span></div>
    </div>
    <div class="error-message-text-box w-100 mb-2 col-12 row m-0" *ngIf="ruleIndex === (rulesSet.rules.length-1)">
        <span class="info-rule">then</span>
        <div class="kr-sg-dropdowns col-3">                           
            <div class="dropdown dropdown-open" ngbDropdown>
                <button class="dropdown-toggle dropdown-input"  ngbDropdownToggle>Choose </button>                                            
                <ul class="dropdown-menu content-menu p-0" ngbDropdownMenu (click)="$event.stopImmediatePropagation()"> 
                    <ng-container *ngIf="rulesObj && rulesObj.then">
                        <li (click)='rulesObj.then.resultCategory="FilterResults"'>Filter Results</li>  
                        <li (click)='rulesObj.then.resultCategory="HidetResults"'>Hide Results</li>  
                        <li (click)='rulesObj.then.resultCategory="BoostResults"'>Boost Results</li>  
                        <li (click)='rulesObj.then.resultCategory="BurryResults"'>Burry Results</li>
                        <li (click)='rulesObj.then.resultCategory="RewriteQuery"'>Rewrite Query</li>         
                    </ng-container>
                </ul>
            </div>
        </div>
        <div class="kr-sg-input-text col-9">
            <app-group-input [customEmitter]='true' (emitValues)="addedGroupToRule($event,rule,'then')"></app-group-input>           
        </div>     
    </div>
    </ng-container>
</ng-template>

<div class="rules-table-container">
    <div class="tab-sec-top">
        <div class="d-flex">
          <div (click)='selectTab("attributes")' class="tab-name" [ngClass]="{'active': selectedTab==='attributes'}">Attributes</div>
          <div (click)='selectTab("rules")' class="tab-name" [ngClass]="{'active': selectedTab==='rules'}">Rules</div>
          <div  (click)='selectTab("signals")' class="tab-name" [ngClass]="{'active': selectedTab==='signals'}">Signals</div>
        </div>
        <div class="header-sec">
            <div class="kr-sg-input-search">                               
                <input type="text" placeholder="Search" class="input-search" id="searchFaqs" name='faqsSearch' [(ngModel)]="searchBlock">
                <img src="assets/icons/search-gray.svg" class="search-icon">
            </div>
            <button class="kr-sg-button-secondary btn_lg" (click)="addEditRules()" *ngIf="selectedTab==='rules'">Add</button>
            <button class="kr-sg-button-secondary btn_lg" (click)="addEditAttibutes()" *ngIf="selectedTab ==='attributes'">Add</button>
        </div>
    </div>
   <ng-container *ngIf="selectedTab==='rules'">
    <div class="faq-header-sec row m-0">
        <div class="col-12 left-sec p-0">
            <div class="tab-sec d-flex">
                <div class="tab_title active">Drafts<span>(0)</span></div>
                <div class="tab_title">In-review<span>(0)</span></div>
                <div class="tab_title">Approved<span>(0)</span></div>
            </div>
        </div>       
    </div>
    <div class="table-list-content" *ngIf="selectedRulesOnj && rules && rules.length && !loadingRules">
        <div class="kr-sg-data-table">      
          <section class="table-content">
            <header class="table-header">
              <div class="col-3 col_">
                <div class="kr-sg-checkbox">
                  <input id="checkbox-12" class="checkbox-custom" type="checkbox">
                  <label for="checkbox-12" class="checkbox-custom-label"></label>
                </div> 
                <span>RULE NAME<img src="assets/icons/caretDown.svg" class="ml-1 sortImg"></span>
              </div>
              <div class="col_ col-7">DEFINITION</div>                            
            </header>
            <ng-container >
              <perfect-scrollbar class="table-scroll-perfect rulse_tab if-select-all">
                <div class="content-body">
                    <div class="col_ col-2">
                      <div class="kr-sg-checkbox">
                        <input id="checkbox-13" class="checkbox-custom" type="checkbox">
                        <label for="checkbox-13" class="checkbox-custom-label"></label>
                      </div> 
                      <span>Citi Bank</span>
                    </div>                    
                    <div class="col_ col-7 definatation">If <b>“Search Context.RecentSearches”</b> Contains <b>“Credit”</b> OR <b>“Card”</b> AND <b>“User Context.CustomerType”</b> Starts With <b>“Premium”</b> THEN Filter Results Containing <b>“Card Offers”</b> OR <b>“Card Rewards”</b></div>               
                    <div class="actions draft-state col_ col-3 text-right pr-3">
                      <img src="assets/icons/edit-rule.svg" class="ml-4" (click)="openAddRulesModal()">
                      <img src="assets/icons/return.svg" class="ml-4">
                      <img src="assets/icons/delete-table.svg" class="ml-4">
                    </div>
                    <div class="actions approve-state d-none col-3 text-right pr-3">
                      <button class="kr-sg-button-primary btn_lg ml-4">Approve</button>
                      <img src="assets/icons/return.svg" class="ml-4">
                      <img src="assets/icons/delete-table.svg" class="ml-4">
                    </div>
                </div>  
                <div class="content-body check-all-bg">
                  <div class="col_ col-2">
                    <div class="kr-sg-checkbox">
                      <input id="checkbox-13" class="checkbox-custom" type="checkbox">
                      <label for="checkbox-13" class="checkbox-custom-label"></label>
                    </div> 
                    <span>Citi Bank</span>
                  </div>                    
                  <div class="col_ col-7 definatation">If <b>“Search Context.RecentSearches”</b> Contains <b>“Credit”</b> OR <b>“Card”</b> AND <b>“User Context.CustomerType”</b> Starts With <b>“Premium”</b> THEN Filter Results Containing <b>“Card Offers”</b> OR <b>“Card Rewards”</b></div>               
                  <div class="actions draft-state col_ col-3 text-right pr-3">
                    <img src="assets/icons/edit-rule.svg" class="ml-4" (click)="openAddRulesModal()">
                    <img src="assets/icons/return.svg" class="ml-4">
                    <img src="assets/icons/delete-table.svg" class="ml-4">
                  </div>
                  <div class="actions approve-state d-none col-3 text-right pr-3">
                    <button class="kr-sg-button-primary btn_lg ml-4">Approve</button>
                    <img src="assets/icons/return.svg" class="ml-4">
                    <img src="assets/icons/delete-table.svg" class="ml-4">
                  </div>
              </div>        
            </perfect-scrollbar>
            </ng-container>
            <div class="footer-btns">
              <button class="kr-sg-button-primary btn_lg">Send for Review</button>
              <button class="kr-sg-button-danger btn_lg">Delete</button>
            </div>
          </section>       
        </div>
    </div>
    <div *ngIf="loadingRules" class="p-5 text-center">
      Lading....
    </div>
    <div *ngIf="!(rules && rules.length) && !loadingRules" class="p-5 text-center">
      No rules added yet
    </div>
   </ng-container>
   <ng-container  *ngIf="selectedTab==='attributes'">
    <div class="table-list-content attributes-rules-tab-content" *ngIf="attributes && attributes.groups && attributes.groups.length && !loading">
        <div class="kr-sg-data-table with-checkbox">
          <section class="table-content">
            <header class="table-header">
              <div class="col_ col-3">
                <div class="kr-sg-checkbox hide">
                  <input id="checkbox-10" class="checkbox-custom" type="checkbox">
                  <label for="checkbox-10" class="checkbox-custom-label"></label>
                </div> 
                <span>ATTRIBUTE NAME<img src="assets/icons/caretDown.svg" class="ml-1 sortImg"></span>
              </div>
              <div class="col_ col-4">DEFINITION</div>
              <div class="col_ col-2">TYPE</div>
              <div class="col_ col-2">IS FACET</div>
            </header>
            <perfect-scrollbar class="table-scroll-perfect if-select-all">
              <ng-container>
                <div class="content-body" *ngFor="let attribute of attributes.groups  |  filter:[ searchBlock ,'name']">
                  <div class="col_ col-3">
                    <div class="kr-sg-checkbox hide">
                      <input id="checkbox-10" class="checkbox-custom" type="checkbox">
                      <label for="checkbox-10" class="checkbox-custom-label"></label>
                    </div> 
                    <span>{{attribute.name}}</span>
                    </div>
                  <div class="col_ col-4"><span class='eachAttr' *ngFor="let value of attribute.attributes; let i = index ">{{value.value + ((index === (attribute.attributes.length-1))?'':',')}} </span></div>  
                  <div class="col_ col-2" >{{attribute.type || 'Systom/Auto'}}</div>  
                  <div class="col_ col-2">{{attribute.isFacet || 'Yes' }}</div>         
                  <div class="col_ col-1 pl-0 text-right pr-4 actions">
                    <img src="assets/images/edit-pencil.svg" class="mr-4 hide">
                    <img src="assets/icons/delete-table.svg">
                  </div>   
                </div>
              </ng-container>
              <div class="divBlockEmptylastChild">No Results found</div>
            </perfect-scrollbar>
            <div class="footer-btns" *ngIf="selectedRulesOnj && selectedRulesOnj.selectedCount">
              <button class="kr-sg-button-primary btn_lg">Send for Review</button>
              <button class="kr-sg-button-danger btn_lg">Delete</button>
            </div>
          </section>
        </div>
      </div>
      <div *ngIf="loading" class="p-5 text-center">
        Lading....
      </div>
      <div *ngIf="!(attributes.groups && attributes.groups.length) && !loading" class="p-5 text-center">
        No Attributes added yet
     </div>
   </ng-container>
 </div>

<kr-modal modalType="center" modalClass="addRulesModalComponent" #addRulesModalPop>
    <div class="modal-header">
        <div class="header-title" (click)='closeAddRulesModal()'><img src="assets/images/closeCross.png" class="closeCross closeRules pr-2"> <span class="">Add Rules</span></div>        
    </div>
    <div class="modal-body">
    <div class="col-12 pl-5 pr-0" *ngIf="validationRules && validationRules.rules && validationRules.rules.length">
        <ng-container *ngFor="let simpleRule of validationRules.rules; index as parentIndex">
            <div class="kr-sg-input-text mb-3 rule-name-input">
                <input type="text" placeholder="" class="input-text">
            </div>
            <div class="validation-setting-rules" >
                <ng-container *ngFor="let rule of simpleRule.rules; index as i">
                    <ng-container 
                        *ngTemplateOutlet="ruleContainer; context{$implicit: validationRules,rulesSet:simpleRule,rule:rule,ruleIndex:i,validationMode:'simple'}">
                    </ng-container>
                </ng-container>
            </div>  
        </ng-container>
    </div>
  </div>
  <div class="modal-footer">                               
    <button class="kr-sg-button-primary btn_md" (click)="saveRules()" >Ok</button>
    <button class="kr-sg-button-secondary btn_md" data-dismiss="modal" (click)="closeAddRulesModal()">Cancel</button>
   </div>
</kr-modal>
<kr-modal modalType="center" modalClass="addRulesModalComponent" #addAttributesModalPop>
    <div class="modal-header">
        <div class="header-title" (click)='closeAddAttributesModal()'><img src="assets/images/closeCross.png" class="closeCross"></div>        
    </div>
    <div class="modal-body">
            <div class="kr-sg-input-text mb-15">
              <div class="label-text">Addtribute name</div>
              <input type="text" placeholder="Enter name" class="input-text" [(ngModel)]="addEditattribute.name" required autocomplete="off">             
           </div>
           <div for="tagInput" class="label_text">values</div>
           <mat-form-field class="example-chip-list mb-15" [floatLabel]="'never'">
            <mat-chip-list #chipList aria-label="tag selection">
              <mat-chip *ngFor="let tag of addEditattribute.attributes; let index = index" (removed)="removeAltTag(tag)">
                 <div class="mat-value" *ngIf="tag">{{tag.value}}</div> 
                <mat-icon matChipRemove><img src="assets/images/close.svg"></mat-icon>
              </mat-chip>
              <input placeholder="Type & enter" [(ngModel)]="addEditattribute.newTag" [matChipInputFor]="chipList" [matChipInputSeparatorKeyCodes]="separatorKeysCodes" name = "tagInput"  (matChipInputTokenEnd)="addAltTag($event)" id="tagInput" (click)="$event.stopPropagation()">
            </mat-chip-list>
          </mat-form-field> 
           <div class="kr-sg-dropdowns w-100">
            <div class="label-text">Label</div>
            <div class="dropdown dropdown-open">
                <button class="dropdown-toggle dropdown-input" data-toggle="dropdown">{{addEditattribute.type?addEditattribute.type:'Choose'}}</button>                                            
                <ul class="dropdown-menu content-menu">
                  <li (click)="addEditattribute.type='systemAuto'">System/Auto</li>
                  <li (click)="addEditattribute.type='custom'">Custom</li>
                </ul>
             </div>
           </div>
           <div class="kr-sg-dropdowns w-100">
            <div class="label-text">Label</div>
            <div class="dropdown dropdown-open">
                <button class="dropdown-toggle dropdown-input" data-toggle="dropdown">{{addEditattribute.isFacet?addEditattribute.isFacet:'Choose'}}</button>                                            
                <ul class="dropdown-menu content-menu">
                  <li (click)="addEditattribute.isFacet='Yes'">Yes</li>
                  <li (click)="addEditattribute.isFacet='No'">No</li>
                </ul>
              </div>
           </div>
     </div>
   <div class="modal-footer">                               
    <button class="kr-sg-button-primary btn_md" (click)="saveAttributes()" >Ok</button>
    <button class="kr-sg-button-secondary btn_md" data-dismiss="modal" (click)="closeAddAttributesModal()">Cancel</button>
   </div>
</kr-modal>