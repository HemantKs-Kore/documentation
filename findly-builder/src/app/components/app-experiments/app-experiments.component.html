<div class="experiment-container">
  <div class="mainLoadingSpinner" *ngIf="loadingContent">
    <mat-spinner diameter="18" strokeWidth="2"></mat-spinner>
    <span class="please-wait-message">{{'please_wait'| translate}}</span>
  </div>
  <div *ngIf="loadingContent1">
    <div class="header-sec row"  *ngIf='listOfExperiments.length>0||filterExperiments.length>0'>
      <!-- <app-useronboarding-journey [componentType]='componentType'></app-useronboarding-journey> -->
      <div class="col-6 left-sec p-0">
        <div class="tab-sec d-flex">
          <b>{{"experiments.name"| translate}}</b>
        </div>
      </div>
      <div class="col-6 p-0 right-sec d-flex align-items-center justify-content-end">
       
        <div class="kr-sg-input-search m-0"  [ngClass]="{'d-none': !showSearch}" style="float: left">                               
          <input type="text" placeholder="Search" id="inputSearch" class="input-search"  [ngClass]="{'pl-33':!searchFields,'pl-2':searchFields}" autocomplete="off" [(ngModel)]="searchFields" (focusout)="focusoutSearch();" maxlength="50" (mouseover)="searchImgSrc = (searchFocusIn ? 'assets/icons/search_gray.svg' :'assets/icons/search_gray_dark.svg')"
          (mouseout)="searchFocusIn=false;searchImgSrc = 'assets/icons/search_gray.svg'" (focus)="searchFocusIn=true;searchImgSrc = 'assets/icons/search_gray.svg'">
      <img [src]="searchImgSrc" class="search-icon" *ngIf="!searchFields">
      <img class="close-icon" *ngIf="searchFields" src="assets/icons/close_icon.svg" [ngClass]="{'pr-22':searchFields}"  (mouseover)="activeClose=true" (mouseout)="activeClose=false" (click)="searchFields='';showSearch=!showSearch;"  placement="top-center" container='body' ngbTooltip="Cancel" tooltipClass="ngb_tooltip_custom_class sampleJson">
      </div> 
        <div class="searchBlock" (click)="showSearch=!showSearch;focusinSearch('inputSearch')" *ngIf="listOfExperiments.length>0||filterExperiments.length>0">
          <span [ngClass]="{'d-none': showSearch}" class="mr-3" id="btn_toggle_search_structured_data" ><img src="assets/icons/search.svg" [ngClass]="{'d-none': showSearch}">{{'search' | translate}}</span>
      </div>
        <div (click)="addExperiment('add')" class="title">
          <img src="assets/icons/add_plus.svg" />{{"experiments.add_btn"| translate}}
        </div>
      </div>
    </div>
    <perfect-scrollbar class="p-scroll-data" [ngClass]="{'scroll-empty-screen': filterExperiments.length===0}">
      <div class="table-data-content">
        <div class="row m-0 header-data col-12"  *ngIf='filterExperiments.length>0'>
          <div class="col-3 h-title d-flex align-items-center">
            {{"experiments.exp_name"| translate}}</div>
          <div class="col-3 h-title">
            {{"experiments.variants"| translate}}</div>
          <!-- <div class="col-2 h-title">Winner</div> -->
          <div class="col-2 d-flex align-items-center h-title" (click)="sortBy('state')">
            <span class="d-flex align-items-center flex-column mr-1">
              <img [ngClass]="getSortIconVisibility('state', 'down')" src="assets/icons/caretDown.svg" class="ml-1 sortImg downArrow">
              <img [ngClass]="getSortIconVisibility('state', 'up')" src="assets/icons/caretDown.svg" class="ml-1 sortImg upArrow">
            </span>
            {{"experiments.status"| translate}}&nbsp;
            <div class="kr-sg-dropdowns type_sort_dropdown" #statusFilter="ngbDropdown" ngbDropdown [container]="'body'"
              [autoClose]="true" [placement]="'bottom-right'">
              <div class="dropdown dropdown-open">
                <button class="dropdown-toggle dropdown-input" ngbDropdownToggle (click)="$event.stopPropagation()">
                  <!-- <img src="assets/icons/caretDown.svg"
                    [ngClass]="{'assending': (selectedSort==='recentStatus') && isAsc,'decending':(selectedSort==='recentStatus') && !isAsc}"
                    class="ml-1 sortImg"> -->
                    <img class="custom-dropdown-toggle-icon" src="assets/icons/Vector.svg">
                </button>
                <ul class="dropdown-menu content-menu type_sort_dropdown-content" ngbDropdownMenu>
                  <li *ngFor="let status of dynamicStatus" (click)="selectedTab(status);statusFilter.close()"><span
                      class="list-name">{{status|titlecase}}</span><img [ngClass]="{'hide': status !== setTab}" src="assets/icons/check-blue.svg"></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-3 h-title d-flex align-items-center">  
            {{"experiments.duration"| translate}}</div>
        </div>
        <div id="accordion">
          <div class="acc-card" *ngFor="
              let exp of listOfExperiments | filter: [searchFields, 'name'];let exp_index=index;
            ">
            <div class="acc-card-header">
              <div class="acc-card-link collapsed" data-toggle="collapse" attr.data-target="#{{ exp._id }}">
                <div class="row m-0 col-12 row_data">
                  <div class="col-3 ex-title">{{ exp.name }}</div>
                  <div class="col-3 variants">
                    <div class="variants-block left">
                      <span class="v-name" *ngFor="let vari of exp.variants; let index = index" [style.background-color]="vari.color" [hidden]="index === 3">
                        <span *ngIf="(index < 2)">{{vari.code }}</span>
                        <span *ngIf="(index > 1) && (index === 2)">{{exp_index==2?'+ 1 ':'+ 2 '}}</span>
                      </span>
                    </div>
                    <div class="variants-block right">
                      <span *ngFor="let vari of exp.variants; let index = index">
                        <span *ngIf="exp.top_leader === vari.code &&exp.state !== 'configured'">
                        <span class="v-name status" [style.background-color]="vari.color">{{ exp.top_leader }}</span>
                        <span class="winner" *ngIf="vari.leader"><img src="assets/icons/experiment/leader.svg" alt="leader"></span>
                        <span class="winner" *ngIf="vari.winner">{{"experiments.winner"| translate}}</span></span>
                      </span>
                    </div>
                  </div>
                  <!-- <div class="col-2 winner-block">
                    <div class="variants-block">
                      <span *ngFor="let vari of exp.variants; let index = index" class="winner-content">
                        <span class="v-name" [style.background-color]="vari.color">{{ vari.code }}</span>
                        <span class="winner" *ngIf="vari.leader && (index === exp.variants.length - 1)"><img
                            src="assets/icons/experiment/leader.svg" alt="leader"></span>
                        <span class="winner" *ngIf="vari.winner && (index === exp.variants.length - 1)"><img
                            src="assets/icons/experiment/winner.svg" alt="winner"></span>
                      </span>
                    </div>
                  </div> -->
                  <div class="col-2 status">
                    <span class="a-status" [ngClass]="exp.state">{{
                      exp.state | titlecase
                      }}</span>
                  </div>
                  <div class="col-3 duration-data d-flex align-items-start" *ngIf="(exp.state !== 'configured') && (exp.state !== 'completed')">
                    <div class="left-sec">
                      <div class="date-stamp">
                        <span class="s-color">{{"experiments.start_date"| translate}}:</span> {{ exp.start | date: "mediumDate" }}
                      </div>
                      <div class="date-stamp">
                        <span class="s-color">{{"experiments.end_date"| translate}}:</span> {{ exp.end | date: "mediumDate" }}
                      </div>
                    </div>
                    <div class="right-sec" *ngIf="exp.state !== 'completed'">
                      <div class="hours">
                        {{ exp.total_days}} {{"experiments.more"| translate}}
                      </div>
                      <div class="hours">
                        <ngb-progressbar type="secondary" [value]="exp.time_result" [max]="24 * exp.duration.days">
                        </ngb-progressbar>
                      </div>
                    </div>
                    <!-- <div class="date-stamp m-0">{{ exp.start | date: "mediumDate" }}</div>
                    <div class="inline-block mb-1">
                      <div class="hour">
                        <ngb-progressbar type="secondary" [value]="exp.date_days" [max]="exp.total_days">
                        </ngb-progressbar>
                      </div>
                      <span class="hours ml-2" *ngIf="exp.state !== 'completed'">{{ exp.date_days }} hrs more to go</span>
                    </div>
                    <div class="text-right date-stamp bottom m-0">{{ exp.end | date: "mediumDate" }}</div> -->
                  </div>
                  <div class="col-4 d-flex align-items-center duration-data" *ngIf="(exp.state === 'completed')">
                    <div class="left-sec">
                      <div class="date-stamp">
                        <span class="s-color">{{"experiments.start_date"| translate}}:</span> {{ exp.start | date: "mediumDate" }}
                      </div>
                    </div>
                    <div class="right-sec">
                      <div class="date-stamp">
                        <span class="s-color">{{"experiments.end_date"| translate}}:</span> {{ exp.end | date: "mediumDate" }}
                      </div>
                    </div>
                  </div>
                  <div class="col-4 d-flex align-items-center duration-data justify-content-between"
                    *ngIf="exp.state === 'configured'">
                    <div class="left-sec border-0 before-none pl-0" [class.col-9]="status_active">
                      <div class="info-data" *ngIf="status_active">
                        <img src="assets/icons/experiment/Info.svg" />{{"experiments.cannot_run"| translate}}
                      </div>
                    </div>
                    <div class="right-sec">
                      <button class="kr-sg-button-secondary btn_lg" [class.mr-2]="!status_active" [disabled]="status_active"
                        (click)="runExperiment(exp._id, 'active', $event)">
                        {{"experiments.run"| translate}}
                      </button>
                      <span (click)="addExperiment('edit', exp)" style="padding-left: 2px; font-size: 9px"
                        *ngIf="!status_active">{{"experiments.view_configuration"| translate}}</span>
                    </div>
                  </div>

                  <div class="delete-table">
                    <img src="assets/icons/pause.svg" ngbTooltip='Pause' *ngIf="exp.state === 'active'"
                      (click)="runExperiment(exp._id, 'paused', $event)" />
                    <img src="assets/icons/End.svg" ngbTooltip='Stop' *ngIf="exp.state === 'active'"
                      (click)="runExperiment(exp._id, 'stopped', $event)" />
                    <img src="assets/icons/play_black.svg"  ngbTooltip='Play'*ngIf="exp.state === 'paused'"
                      (click)="runExperiment(exp._id, 'active', $event)" />
                    <img src="assets/icons/return_black.svg" *ngIf="exp.state === 'stopped'"
                      (click)="runExperiment(exp._id, 'active', $event)" />
                    <img src="assets/icons/delete-table.svg" ngbTooltip='Delete' *ngIf="
                        exp.state === 'completed' ||
                        exp.state === 'stopped' ||
                        exp.state === 'paused'
                      " (click)="deleteExperimentPopup(exp._id, $event)" />
                  </div>

                  <!-- <div class="delete-table" *ngIf="exp.state === 'paused'">
                    <img src="assets/icons/play_black.svg" (click)="runExperiment(exp._id, 'stopped', $event)" />
                  </div>

                  <div class="delete-table" *ngIf="exp.state === 'stopped'">
                    <img src="assets/icons/return_black.svg" (click)="runExperiment(exp._id, 'active', $event)" />
                  </div>

                  <div class="delete-table" (click)="deleteExperimentPopup(exp._id, $event)" *ngIf="exp.state === 'completed' || exp.state === 'stopped' || exp.state === 'paused' || exp.state === 'active'">
                    <img src="assets/icons/delete-table.svg" />
                  </div> -->
                </div>
              </div>
            </div>
            <div id="{{ exp._id }}" class="collapse" data-parent="#accordion">
              <div class="acc-card-body">
                <div class="bg-sec">
                  <div class="row m-0 col-12 acc-row-header">
                    <div class="col-2 title">{{"experiments.variant"| translate}}</div>
                    <div class="col-2 title">{{"experiments.index"| translate}}</div>
                    <div class="col-2 title">{{"experiments.search_config"| translate}}</div>
                    <div class="col-1 title">{{"experiments.traffic"| translate}}</div>
                    <div class="col-1 title">{{"experiments.users"| translate}}</div>
                    <div class="col-1 title">{{"experiments.searches"| translate}}></div>
                    <div class="col-1 title">{{"experiments.clicks"| translate}}</div>
                    <div class="col-2 title">{{"experiments.ctr"| translate}}  <span placement="top-center" [ngbTooltip]="ctrTooltip" [container]='"body"' tooltipClass="metrics_tooltips m-0"><img src="assets/icons/overview/Info.svg"></span></div>
                  </div>
                  <div class="row m-0 col-12 acc-row-body align-items-center" *ngFor="let expCol of exp.variants">
                    <div class="col-2 d-flex varient-data align-items-center">
                      <div class="name-letter" [style.background-color]="expCol.color">
                        {{ expCol.code }}
                      </div>
                      <div class="name">
                        {{ expCol.name | titlecase }}</div>
                    </div>
                    <div class="col-2 title">
                      {{ expCol.indexPipelineName | titlecase }}
                    </div>
                    <div class="col-2 title">
                      {{ expCol.queryPipelineName | titlecase }}
                    </div>
                    <div class="col-1 title">{{ expCol.trafficPct }}%</div>
                    <div class="col-1 title">{{ expCol.users || 0 }}</div>
                    <div class="col-1 title">{{ expCol.searches }}</div>
                    <div class="col-1 title">{{ expCol.clicks }}</div>
                    <div class="col-2 title" [class.leader_percent]="(expCol.searches > 0) && (expCol.leader)">
                      {{
                      expCol.ctr > 0
                      ? expCol.toFixed(2) + "%"
                      : expCol.ctr
                      }}
                    </div>
                  </div>
                  <div class="v-search-config">
                    <span (click)="addExperiment('edit', exp)">{{"experiments.view_configuration"| translate}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <ng-container>
        <div class="upgrade-experience" [ngClass]='{"d-none":currentSubscriptionPlan.planName!="Free"}'>
          <div class="img-block">
            <img src="assets/icons/pricing/upgrade-experience.svg">
          </div>
          <div class="title">{{"experiments.empty_experiment"| translate}}</div>
          <button class="kr-sg-button-primary btn_lg" (click)="upgrade()">{{"experiments.upgrade"| translate}}</button>
        </div>
      </ng-container>

      <ng-container *ngIf="filterExperiments.length===0 && currentSubscriptionPlan.planName!='Free'">        
        <div  class="empty-landing-screen" >
          <div class="img-block"><img class="action_icon" src="assets/images/experiments-empty.svg" (load)="imageLoaded()"></div>
          <ng-container *ngIf="loadImageText">
              <div class="empty-title">{{"experiments.havenot_added"| translate}}</div>
              <div class="desc-text">{{"experiments.desc_text"| translate}}</div>
              <!-- <div class="kr-sg-dropdowns" ngbDropdown [container]="'body'">                                          -->
                <button class="kr-sg-button-primary btn_lg px-3" (click)="addExperiment('add')">{{"experiments.add_btn"| translate}}</button>                                            
              <!-- </div> -->
          </ng-container>
        </div>    
    </ng-container>
<div class="no-experiments" *ngIf="filterExperiments.length!=0&&listOfExperiments.length===0">
        <div>{{"experiments.no_result_found"| translate}}</div>
      </div>
      <!-- <div *ngIf='listOfExperiments.length>0' style="margin-right:45px;"><app-record-pagination [totalRecord]='exp_totalRecord' [limitpage]='exp_limitPage' (pageChanged)="paginate($event)"></app-record-pagination></div> -->
    </perfect-scrollbar>
  </div>
</div> 
<!---add popup-->
<kr-modal modalType="center" modalClass="modal_popups_ addFieldModalPop smallModal" #addExperiments>
  <div class="modal-header">
    <div class="title">{{form_type === 'edit'?("experiments.view_experiment"| translate):("experiments.new_experiment"| translate)}}</div>
    <div class="close_icon" (click)="closeModalPopup()">
      <img src="assets/icons/modal-close.svg" />
    </div>
  </div>
  <perfect-scrollbar class="perfect-scroll-modal-body">
    <!-- <div
      class="kr-sg-multi-line-notification"
    >
      <div class="bulb-icon">
        <img src="assets/icons/info-blue.svg" />
      </div>
      <div class="tost-text">{{ status }} Experiment cannot be edited.</div>
    </div> -->
    <div class="modal-body textAlignLeft">
      <div class="info-notifcation" *ngIf="exp_status !== 'configured' && form_type === 'edit'">
        <img src="assets/icons/info-blue.svg" />
        <span class="title">{{ exp_status | titlecase }} Experiment cannot be edited</span>
      </div>
      <div class="row ml-0 mr-0 mb-3 col-12 p-0 pr-30">
        <div class="kr-sg-input-text col-8 pl-pr-5">
          <div class="label-text">Experiment Name</div>
          <input type="text" autocomplete="off" id="enterName"placeholder="Enter Experiment Name" class="input-text"  (blur)="inputChanged('enterName')" (change)="inputChanged('enterName')"
            [(ngModel)]="experimentObj.name" [disabled]="exp_status !== 'configured' && form_type === 'edit'" [ngClass]="{
              disable_edit: exp_status !== 'configured' && form_type === 'edit'
            }" [ngStyle]='{"background-color":(exp_status !== "configured" && form_type === "edit")?"#EFF0F1":"#ffffff","border-color":(exp_status !== "configured" && form_type === "edit")?"#f3f3f4":"#BDC1C6"}'/>
            <img id="infoWarning" src="assets/icons/warning_escalation.svg" style="display: none;" height="12" width="12" />
        </div>
      </div>

      <div class="row ml-0 mr-0 mb-3 col-12 p-0 pr-30" *ngFor="let vari of variantsArray; let varIndex = index">
        <div class="kr-sg-input-text col-4 pl-pr-5 ifvariant"> 
          <div class="label-text">Variant Name</div>
          <input type="text" autocomplete="off" #varName placeholder="Enter Variant Name" class="input-text"  id ="variantName{{varIndex}}"  (change)="inputChanged('variantName', varIndex)"
            [(ngModel)]="vari.name" (blur)="fetchVariant(varIndex, varName.value, 'name'); inputChanged('variantName', varIndex)"
            [disabled]="exp_status !== 'configured' && form_type === 'edit'" [ngClass]="{
              disable_edit: exp_status !== 'configured' && form_type === 'edit'
            }" />
          <span class="v-name" [style.background-color]="vari.color">{{
            vari.code
            }}</span>
            <img id="infoWarning{{varIndex}}" src="assets/icons/warning_escalation.svg" style="display: none;" height="12" width="12" />
        </div>
        <div class="kr-sg-dropdowns col-4 pl-pr-5">
          <div class="label-text">Index</div>
          <div class="dropdown dropdown-open">
            <button class="dropdown-toggle dropdown-input" data-toggle="dropdown" id="indexPipelineName{{varIndex}}"     
              [disabled]="exp_status !== 'configured' && form_type === 'edit'" [ngStyle]='{"background-color":(exp_status !== "configured" && form_type === "edit")?"#EFF0F1":"#ffffff","color":(vari.indexPipelineName==undefined)||(exp_status !== "configured" && form_type === "edit")?"#9aa0a6":"#202124","border-color":(exp_status !== "configured" && form_type === "edit")?"#f3f3f4":"#BDC1C6"}'>
              {{
              vari.indexPipelineName === undefined
              ? varIndex===0? "Default Index":"Select Index"
              : vari.indexPipelineName
              }}
            </button>
            <ul class="dropdown-menu content-menu" >
              <li *ngFor="let index of indexConfig" (click)="fetchVariant(varIndex, index, 'indexid');getQueryPipeline(index._id)" [ngStyle]="{'font-weight':vari.indexPipelineId===index._id?'bold':''}">
                {{ index.name=='Default'?"Default Index":index.name }}
              </li>
            </ul>
          </div>
        </div>
        <div class="kr-sg-dropdowns col-4 pl-pr-5">
          <div class="label-text">Search Configuration</div>
          <div class="dropdown dropdown-open">
            <button class="dropdown-toggle dropdown-input" data-toggle="dropdown" id="queryPipelineName{{varIndex}}"  
              [disabled]="(exp_status !== 'configured' && form_type === 'edit')||vari.indexPipelineName==undefined" [ngStyle]='{"background-color":(exp_status !== "configured" && form_type === "edit")||vari.indexPipelineName==undefined?"#EFF0F1":"#ffffff","color":(vari.indexPipelineName==undefined)||(exp_status !== "configured" && form_type === "edit")?"#9aa0a6":"#202124","border-color":(exp_status !== "configured" && form_type === "edit")?"#f3f3f4":"#BDC1C6"}'>
              {{
              vari.queryPipelineName === undefined
              ? varIndex===0? "Default Search":"Select Search Configuration"
              : vari.queryPipelineName
              }}
            </button>
            <ul class="dropdown-menu content-menu"  *ngIf="vari.indexPipelineName!==undefined">
              <li *ngFor="let query of queryPipeline" (click)="fetchVariant(varIndex, query, 'queryid')"  [ngStyle]="{'font-weight':vari.queryPipelineId===query._id?'bold':''}">
                {{ query.name=='Default'?"Default Search":query.name }}
              </li>
            </ul>
          </div>
        </div>
        <div class="delete-rule" (click)="removeVariant(varIndex)"
          [hidden]="exp_status !== 'configured' && form_type === 'edit'">
          <img src="assets/icons/modal-close.svg" />
        </div>
      </div>

      <div class="mb-3 variant-add" (click)="addVarient()" *ngIf="variantsArray.length < 4"
        [hidden]="exp_status !== 'configured' && form_type === 'edit'">
        <img src="assets/icons/add_blue.svg" />Add Variant
      </div>

      <div class="trafic-sec" >
        <div class="pl-pr-5 slider-sec">
          <div class="label-text">Traffic</div>
          <nouislider *ngIf="showSlider" #sliderref [config]="someRangeconfig" [(ngModel)]="someRange" (slide)="sliderChanged()"></nouislider>
        </div>
        <div class="percentage-sec">
          <div class="names" *ngFor="let code of variantsArray">
            <span class="name" [style.background-color]="code.color">{{
              code.code
              }}</span><span class="perentage">{{ code.trafficPct }}%</span>
          </div>
          <!-- <div class="names">
            <span class="name">B</span><span class="perentage">50%</span>
          </div> -->
        </div>
      </div>

      <div class="duration-sec">
        <div class="kr-sg-input-text">
          <div class="label-text">Duration</div>
          <input type="number" autocomplete="off" class="input-text text-center" min="30" max="90" (keyup)="checkDuration(experimentObj?.duration.days)"
            [(ngModel)]="experimentObj?.duration.days" [disabled]="exp_status !== 'configured' && form_type === 'edit'" [ngStyle]='{"background-color":(exp_status !== "configured" && form_type === "edit")?"#EFF0F1":"#ffffff","border-color":(exp_status !== "configured" && form_type === "edit")?"#f3f3f4":"#BDC1C6"}' />
          <img src="assets/icons/minus.svg" class="minus" [hidden]="exp_status !== 'configured' && form_type === 'edit'"
            (click)="
              experimentObj?.duration.days =
                experimentObj?.duration.days >= 1
                  ? experimentObj?.duration.days - 1
                  : 30
            " />
          <img src="assets/icons/plus_gray.svg" class="plus"
            [hidden]="exp_status !== 'configured' && form_type === 'edit'" (click)="
              experimentObj?.duration.days =
                experimentObj?.duration.days <= 89
                  ? experimentObj?.duration.days + 1
                  : 90
            " />
        </div>
        Days
      </div>
    </div>
  </perfect-scrollbar>
  <div class="modal-footer text-left">
    <button type="button" class="kr-sg-button-primary btn_lg float-right" (click)="validateSource()" [disabled]="(exp_status !== 'configured' && form_type === 'edit')"> 
   <!-- [disabled]="
   !experimentObj.name ||
          (exp_status !== 'configured' && form_type === 'edit') || (variantsArray.length < 2) || (experimentObj?.duration.days < 1)
        " -->
     Add
    </button>
    <button type="button" class="kr-sg-button-secondary btn_lg float-right" (click)="closeModalPopup()">
      Cancel
    </button>
  </div>
</kr-modal>

<!-- upgrade plan component-->
<app-upgrade-plan #plans></app-upgrade-plan>