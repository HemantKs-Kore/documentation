<div class="experiment-container">
  <div class="mainLoadingSpinner" *ngIf="loadingContent">
    <mat-spinner diameter="18" strokeWidth="2"></mat-spinner>
    <span class="please-wait-message">Please Wait!</span>
  </div>
  <div *ngIf="!loadingContent">
    <div class="header-sec row">
      <div class="col-6 left-sec p-0">
        <div class="tab-sec d-flex">
          <div class="tab_title" [ngClass]="{ active: setTab === 'all' }" (click)="selectedTab('all')">
            All<span>({{ allExp }})</span>
          </div>
          <div class="tab_title" [ngClass]="{ active: setTab === 'configured' }" (click)="selectedTab('configured')">
            Configured<span>({{ confExp }})</span>
          </div>
          <div class="tab_title" [ngClass]="{ active: setTab === 'active' }" (click)="selectedTab('active')">
            Active<span>({{ actExp }})</span>
          </div>
          <div class="tab_title" [ngClass]="{ active: setTab === 'paused' }" (click)="selectedTab('paused')">
            Paused<span>({{ pauExp }})</span>
          </div>
          <div class="tab_title" [ngClass]="{ active: setTab === 'completed' }" (click)="selectedTab('completed')">
            Completed<span>({{ compExp }})</span>
          </div>
        </div>
      </div>
      <div class="col-6 p-0 right-sec d-flex align-items-center justify-content-end">
        <div class="kr-sg-input-search m-0" [ngClass]="{ active: showSearch }" style="float: left">
          <input type="text" placeholder="Search" autocomplete="off" class="input-search" name="searchSources"
            placeholder="Search" id="fieldSearchId" [(ngModel)]="searchFields" />
        </div>
        <div class="seach-block" (click)="toggleSearch()">
          <img *ngIf="!showSearch" src="assets/icons/search.svg" /><img *ngIf="showSearch"
            src="assets/images/close.svg" />Search
        </div>
        <div (click)="addExperiment('add')" class="title">
          <img src="assets/icons/add_plus.svg" />Add Experiment
        </div>
      </div>
    </div>
    <perfect-scrollbar class="p-scroll-data">
      <div class="table-data-content" *ngIf="listOfExperiments && listOfExperiments.length">
        <div class="row m-0 header-data col-12">
          <div class="col-3 h-title">Experiment Name</div>
          <div class="col-3 h-title">Variants</div>
          <div class="col-2 h-title">Status</div>
          <div class="col-4 h-title">DURATION</div>
        </div>
        <div id="accordion">
          <div class="acc-card" *ngFor="
              let exp of listOfExperiments | filter: [searchFields, 'name']
            ">
            <div class="acc-card-header">
              <div class="acc-card-link collapsed" data-toggle="collapse" attr.data-target="#{{ exp._id }}">
                <div class="row m-0 col-12 row_data">
                  <div class="col-3 ex-title">{{ exp.name }}</div>
                  <div class="col-3 variants">
                    <div class="variants-block left">
                      <span class="v-name" *ngFor="let vari of exp.variants" [style.background-color]="vari.color">{{
                        vari.code }}</span>
                    </div>
                    <div class="variants-block right">
                      <span class="v-name">B</span>
                      <span class="winner">Winner</span>
                    </div>
                  </div>
                  <div class="col-2 status">
                    <span class="a-status" [ngClass]="exp.state">{{
                      exp.state | titlecase
                      }}</span>
                  </div>
                  <div class="col-4 d-flex align-items-center duration-data" *ngIf="exp.state !== 'configured'">
                    <div class="left-sec">
                      <div class="date-stamp">
                        Start Date: {{ exp.start | date: "mediumDate" }}
                      </div>
                      <div class="date-stamp">
                        End Date: {{ exp.end | date: "mediumDate" }}
                      </div>
                    </div>
                    <div class="right-sec">
                      <div class="hours">
                        {{ 24 * exp.date_days }} hrs more to go
                      </div>
                      <div class="hours">
                        <ngb-progressbar type="secondary" [value]="24 * exp.date_days" [max]="24 * exp.duration.days">
                        </ngb-progressbar>
                      </div>
                    </div>
                  </div>
                  <div class="col-4 d-flex align-items-center duration-data" *ngIf="exp.state === 'completed'">
                    <div class="left-sec">
                      <div class="date-stamp">
                        Start Date: {{ exp.start | date: "mediumDate" }}
                      </div>
                    </div>
                    <div class="right-sec">
                      <div class="hours">
                        End Date: {{ exp.end | date: "mediumDate" }}
                      </div>
                    </div>
                  </div>
                  <div class="col-4 d-flex align-items-center duration-data justify-content-between"
                    *ngIf="exp.state === 'configured'">
                    <div class="left-sec border-0">
                      <div class="info-data" *ngIf="status_active">
                        <img src="assets/icons/experiment/Info.svg" />You cannot
                        run multiple experiements
                      </div>
                    </div>
                    <div class="right-sec">
                      <button class="kr-sg-button-secondary btn_lg" [disabled]="status_active"
                        (click)="runExperiment(exp._id, 'active', $event)">
                        Run
                      </button>
                      <span (click)="addExperiment('edit', exp)" style="padding-left: 2px; font-size: 10px"
                        *ngIf="!status_active">View search configuration</span>
                    </div>
                  </div>

                  <div class="delete-table">
                    <img src="assets/icons/pause.svg" *ngIf="exp.state === 'active'" (click)="runExperiment(exp._id, 'paused', $event)" />
                    <img src="assets/icons/End.svg" *ngIf="exp.state === 'active'" (click)="runExperiment(exp._id, 'stopped', $event)" />
                    <img src="assets/icons/play_black.svg" *ngIf="exp.state === 'paused'" (click)="runExperiment(exp._id, 'stopped', $event)" />
                    <img src="assets/icons/return_black.svg" *ngIf="exp.state === 'stopped'" (click)="runExperiment(exp._id, 'active', $event)" />
                    <img src="assets/icons/delete-table.svg" *ngIf="exp.state === 'completed' || exp.state === 'stopped' || exp.state === 'paused' || exp.state === 'active'"/>
                  </div>

                  <!-- <div class="delete-table" *ngIf="exp.state === 'paused'">
                    <img src="assets/icons/play_black.svg" (click)="runExperiment(exp._id, 'stopped', $event)" />
                  </div>

                  <div class="delete-table" *ngIf="exp.state === 'stopped'">
                    <img src="assets/icons/return_black.svg" (click)="runExperiment(exp._id, 'active', $event)" />
                  </div>

                  <div class="delete-table" (click)="deleteExperimentPopup(exp._id, $event)" *ngIf="exp.state === 'completed' || exp.state === 'stopped' || exp.state === 'paused' || exp.state === 'active'">
                    <img src="assets/icons/delete-table.svg" />
                  </div> -->
                </div>
              </div>
            </div>
            <div id="{{ exp._id }}" class="collapse" data-parent="#accordion">
              <div class="acc-card-body">
                <div class="bg-sec">
                  <div class="row m-0 col-12 acc-row-header">
                    <div class="col-3 title">Variant</div>
                    <div class="col-2 title">SEARCH CONFIG</div>
                    <div class="col-2 title">Traffic</div>
                    <div class="col-1 title">users</div>
                    <div class="col-2 title">SearchES</div>
                    <div class="col-2 title">CTR (goal)</div>
                  </div>
                  <div class="row m-0 col-12 acc-row-body align-items-center" *ngFor="let expCol of exp.variants">
                    <div class="col-3 d-flex varient-data align-items-center">
                      <div class="name-letter" [style.background-color]="expCol.color">
                        {{ expCol.code }}
                      </div>
                      <div class="name">{{ expCol.name | titlecase }}</div>
                    </div>
                    <div class="col-2 title">
                      {{ expCol.queryPipelineName | titlecase }}
                    </div>
                    <div class="col-2 title">{{ expCol.trafficPct }}%</div>
                    <div class="col-1 title">3200</div>
                    <div class="col-2 title">{{ expCol.searches }}</div>
                    <div class="col-2 title">
                      {{
                      expCol.searches > 0
                      ? expCol.searches + "%"
                      : expCol.searches
                      }}
                    </div>
                  </div>
                  <div class="v-search-config">
                    <span (click)="addExperiment('edit', exp)">View search configuration</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- <div class="no-experiments">
        <div class="desc">No search results found</div>
      </div> -->
      <div class="no-experiments" *ngIf="!(filterExperiments && filterExperiments.length)">
        <img src="assets/icons/experiment/empty_experiments.svg" />
        <div class="title">You haven't added any Experiment yet</div>
        <div class="dec">
          Fortunately , it is very easy to add one by clicking on the Add
          experiments
        </div>
      </div>
      <div class="no-experiments" *ngIf="!(listOfExperiments && listOfExperiments.length)">
        <div>No results found</div>
      </div>
    </perfect-scrollbar>
  </div>
</div>
<!---add popup-->
<kr-modal modalType="center" modalClass="modal_popups_ addFieldModalPop smallModal" #addExperiments>
  <div class="modal-header">
    <div class="title">New Experiment</div>
    <div class="close_icon" (click)="closeModalPopup()">
      <img src="assets/icons/modal-close.svg" />
    </div>
  </div>
  <perfect-scrollbar class="perfect-scroll-modal-body">
    <!-- <div
      class="kr-sg-multi-line-notification"
    >
      <div class="bulb-icon">
        <img src="assets/icons/info-blue.svg" />
      </div>
      <div class="tost-text">{{ status }} Experiment cannot be edited.</div>
    </div> -->
    <div class="modal-body textAlignLeft">
      <div class="info-notifcation">
        <img src="assets/icons/info-blue.svg">
        <span class="title">Active Experiment cannot be edited</span>
      </div>
      <div class="row ml-0 mr-0 mb-3 col-12 p-0 pr-30">
        <div class="kr-sg-input-text col-6 pl-pr-5">
          <div class="label-text">Name of Experiment</div>
          <input type="text" autocomplete="off" placeholder="Enter Experiment Name" class="input-text"
            [(ngModel)]="experimentObj.name" />
        </div>
      </div>

      <div class="row ml-0 mr-0 mb-3 col-12 p-0 pr-30" *ngFor="let vari of variantsArray; let varIndex = index">
        <div class="kr-sg-input-text col-6 pl-pr-5 ifvariant">
          <div class="label-text">Variant Name</div>
          <input type="text" autocomplete="off" #varName placeholder="Enter Variant Name" class="input-text"
            [(ngModel)]="vari.name" (blur)="fetchVariant(varIndex, varName.value, 'name')" />
          <span class="v-name" [style.background-color]="vari.color">{{
            vari.code
            }}</span>
        </div>
        <div class="kr-sg-dropdowns col-6 pl-pr-5">
          <div class="label-text">Search Configuration</div>
          <div class="dropdown dropdown-open">
            <button class="dropdown-toggle dropdown-input" data-toggle="dropdown">
              {{
              vari.queryPipelineName === undefined
              ? "Select Configuration"
              : vari.queryPipelineName
              }}
            </button>
            <ul class="dropdown-menu content-menu">
              <li *ngFor="let query of queryPipeline" (click)="fetchVariant(varIndex, query, 'queryid')">
                {{ query.name }}
              </li>
            </ul>
          </div>
        </div>
        <div class="delete-rule" (click)="removeVariant(varIndex)">
          <img src="assets/icons/modal-close.svg" />
        </div>
      </div>

      <div class="mb-3 variant-add" (click)="addVarient()">
        <img src="assets/icons/add_blue.svg" />Add Variant
      </div>

      <div class="trafic-sec" *ngIf="showSlider">
        <div class="pl-pr-5 slider-sec">
          <div class="label-text">Traffic</div>
          <nouislider #sliderref [config]="someRangeconfig" [(ngModel)]="someRange" (change)="sliderChanged()">
          </nouislider>
        </div>
        <div class="percentage-sec">
          <div class="names" *ngFor="let code of variantsArray">
            <span class="name" [style.background-color]="code.color">{{
              code.code
              }}</span><span class="perentage">{{ code.trafficPct }}%</span>
          </div>
          <!-- <div class="names">
            <span class="name">B</span><span class="perentage">50%</span>
          </div> -->
        </div>
      </div>

      <div class="duration-sec">
        <div class="kr-sg-input-text">
          <div class="label-text">Duration</div>
          <input type="number" autocomplete="off" class="input-text text-center" min="0" max="90"
            [(ngModel)]="experimentObj?.duration.days" />
          <img src="assets/icons/minus.svg" class="minus" (click)="
              experimentObj?.duration.days =
                experimentObj?.duration.days >= 1
                  ? experimentObj?.duration.days - 1
                  : 0
            " />
          <img src="assets/icons/plus_gray.svg" class="plus" (click)="
              experimentObj?.duration.days =
                experimentObj?.duration.days <= 89
                  ? experimentObj?.duration.days + 1
                  : 90
            " />
        </div>
        Days
      </div>
    </div>
  </perfect-scrollbar>
  <div class="modal-footer text-left">
    <button type="button" class="kr-sg-button-primary btn_lg float-right" (click)="createExperiment()">
      Add
    </button>
    <button type="button" class="kr-sg-button-secondary btn_lg float-right" (click)="closeModalPopup()">
      Cancel
    </button>
  </div>
</kr-modal>