<ng-template #botResponse let-responses="responses" let-responseObj='responseObj' let-type="reponseType" let-id='id' let-index='index'>  
  <!-- <md-editor formControlName="botResponse" [options]="options" required height="300px"></md-editor> -->
  <!-- add clases when image split mode .image-split-mode and swapmode add this class .swap-positions-->
  <!-- <div class="text-area-editor" [ngClass]="{'swap-positions': responseObj.responseType==='horizontalSplit','image-split-mode': responseObj.responseType ==='verticalSplit'}"> -->
    <div class="text-area-editor">
    <!-- <div class="upload-content-wrapper hide"  *ngIf="(responseObj.responseType !== 'default')">
      <div class="image-selections" (click)="openImgApp(responseObj,index,type)" *ngIf="!(responseObj && responseObj.image && responseObj.image.url)">
          <div class="img_block"><img  src="assets/icons/editor/upload-image.svg"></div>
          <div class="info-text">Upload Image or Video</div>
      </div>
      <div (click)="openImgApp(responseObj,index,type)" class="uploaded-image-preview"  *ngIf="responseObj && responseObj.image && responseObj.image.url && ((responseObj.responseType==='horizontalSplit') || (responseObj.responseType ==='verticalSplit'))">
        <img src="{{responseObj.image.url}}">
      </div>        
    </div> -->
    
    <div class="editor-actons" *ngIf="responseObj.type==='string'">
      <!-- <span class="edit-action">
        <img src="assets/icons/editor/alphabits.svg">
      </span> -->
      <span (click)="onSelected('italic')" class="edit-action">
        <img src="assets/icons/editor/italic.svg">
      </span>
      <span (click)="onSelected('bold')" class="edit-action">
        <img src="assets/icons/editor/bold.svg">
      </span>
      <span  class="edit-action" (click)="onSelected('link')">
        <img src="assets/icons/editor/link.svg">
      </span>
      <span (click)="onSelected('indentLeft')" class="edit-action">
        <img src="assets/icons/editor/align-left.svg">
      </span>
      <!-- <span class="edit-action">
        <img src="assets/icons/editor/align-center.svg">
      </span> -->
      <span (click)="onSelected('indentRight')" class="edit-action">
        <img src="assets/icons/editor/align-right.svg">
      </span>
      <span class="edit-action" (click)="onSelected('ordered')">
        <img src="assets/images/markup/list-ordered.svg">
      </span>
      <span (click)="onSelected('unordered')"  class="edit-action">
        <img src="assets/images/markup/list-unordered.svg">
      </span>
    </div> 
    <div class="kr-sg-input-text-area"> 
      <div *ngIf="responseObj.type==='javascript'" class="-ml-20">
         <ngx-codemirror #codemirror [options]="codeMirrorOptions" [(ngModel)]="responseObj.payload" (ngModelChange)="setEditorContent($event,responseObj,type,index)"> </ngx-codemirror>
      </div>
      <textarea [perfectScrollbar]="config" *ngIf="responseObj.type==='string'"   (focus)="selectCurrentFocusedResponse(id,responseObj,type,index)"  [(ngModel)]="responseObj.payload" class="input-text" style="padding-bottom: 40px;" id="mainChatInputContainer{{type}}_{{index}}"></textarea>
      <div *ngIf="responseObj.type==='external'" class="external-tab-content" >
        <div class="kr-sg-dropdowns mb-3">
          <div class="label-text">Source</div>
          <div class="dropdown dropdown-open">
              <button class="dropdown-toggle dropdown-input" data-toggle="dropdown">Custom</button>                                            
              <ul class="dropdown-menu content-menu">
                <li><a>Custom</a></li>
                <li><a>Add new options</a></li>
              </ul>
          </div>
        </div>
        <div class="kr-sg-input-text mb-3">
            <div class="label-text">ReferenceId</div>
            <input type="text" placeholder="Enter ReferenceId" class="input-text" autocomplete="off">
        </div>
        <!-- <button class="kr-sg-button-primary btn_lg" (click)="openPreviewModal()">Preiew</button> -->
     </div>
    </div>
  </div>
  <div *ngIf="(responseObj.responseType !== 'default')" class="add_image_button_sec">
   <button class="kr-sg-button-secondary btn_lg" (click)="openImgApp(responseObj,index,type)">Add Image</button>
   <span class="imageUrlAdded" *ngIf="responseObj && responseObj.image && responseObj.image.url" title="{{responseObj.image.url}}">{{responseObj.image.url}}</span>
   <span class="dec-info-text" *ngIf="(responseObj.responseType ==='verticalSplit') && (!(responseObj.image && responseObj.image.url))">Add Image with Dimensions of 200px by 400px </span>
   <span class="dec-info-text" *ngIf="(responseObj.responseType ==='horizontalSplit') && (!(responseObj.image && responseObj.image.url))">Add Image with Dimensions of 400px by 200px </span>
  </div>
</ng-template>
<ng-template #botResponsePreview let-responses="responses" let-responseObj='responseObj' let-type="reponseType"
  let-id='id' let-index='index'>
  <div class="body-top-content" (click)="currentEditIndex = index">
    <div class="question-content">
      <div class="conditionalBlock bot-response-view-mode">
        <div class="split_mode" [ngClass]="{'split_mode_verticle': responseObj.responseType ==='verticalSplit'}">
          <div class="img-view-mode" *ngIf="responseObj.responseType !== 'default' && responseObj.image && responseObj.image.url">
            <img src="{{responseObj.image.url}}">
          </div>
          <ng-container>
            <div class="desc-info" *ngIf="responseObj.type==='string'"
              [innerHtml]='convertMDtoHTML.helpers.convertMDtoHTML(responseObj.payload)'></div>
            <div class="desc-info desc-info-javascript-message" *ngIf="responseObj.type==='javascript'">Javascript
              message</div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</ng-template>
<div class="add-questions-form" [ngClass]="inputClass">
  <form [formGroup]="form">
    <div class="kr-sg-input-text mb-15">
      <div class="label-text">Question</div>
      <input type="text" placeholder="Enter your question" class="input-text" formControlName="question" autocomplete="off">             
    </div>
    <!-- <div for="tagInput" class="label-text">Key Terms</div>
    <mat-form-field class="example-chip-list mb-15" [floatLabel]="'never'">
      <mat-chip-list #chipList aria-label="tag selection">
        <mat-chip *ngFor="let tag of tags; let index = index;" (removed)="remove(tag)">
            <div class="mat-val" (click)="$event.stopPropagation()"> {{tag}}</div>
            <mat-icon matChipRemove><img src="assets/images/close.svg"></mat-icon>
        </mat-chip>
        <input placeholder="Type & enter"
              (focus)= "getAltTags($event)"
                [value]="typedQuery"
               [matChipInputFor]="chipList"
               [matAutocomplete]="suggestedItems"
               [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
               (matChipInputTokenEnd)="add($event)" id="tagInput" #suggestedInput (click)="$event.stopPropagation()" autocomplete="off">
        </mat-chip-list>
      <mat-autocomplete #suggestedItems="matAutocomplete" (optionSelected)="selectedTag($event)">
        <ng-container *ngFor = "let suggestion of suggestionTags">
          <mat-option *ngIf="checkDuplicateTags(suggestion)">
            {{suggestion}}
          </mat-option>
        </ng-container>
      </mat-autocomplete>
    </mat-form-field> -->
    <!-- <div class="mb-15">
      <div class="label-text">Groups</div>
      <app-group-input></app-group-input>
    </div> -->
  </form>
  <!-- <hr> -->
  <div class="text">
    <div class="heading">Answer(s)</div>
    <div class="desc">Reorder the conditioned responses to execute in specific order</div>
  </div>
  <ng-container *ngFor="let faqObj of faqResponse.defaultAnswers ; let index = index">
    <div class="body-top-content pointer" title="Click to edit this response" (click)="currentEditIndex = index">
      <div class="question-content">
        <div class="conditionalBlock bot-response-view-mode">
          <div class="bot-response-title">Bot Response <span *ngIf="faqResponse.defaultAnswers.length > 1">{{index + 1}}</span> <span *ngIf="faqObj.answerType !== 'condition'">(DEFAULT)</span>
            <div class="advanced_mode_faq">
              <label class="kr-sg-toggle with-label" *ngIf="(currentEditIndex === index)">
                <input type="checkbox" [checked]='(faqObj.answerType === "condition")' (click)="changeResponseType(faqObj,index)">
                <div class="slider"><span class="disabled">Conditions</span><span class="enabled">Conditions</span></div>
              </label>
            </div>
            <div class="deleteResponseDiv red" (click)="$event.stopPropagation();delete(index)"><img src="assets/images/delete_response.svg">Delete</div>
          </div>
          <div class="condition-view-mode" *ngIf="(faqObj && faqObj.answerType === 'condition') && (currentEditIndex !== index)">
            <div class="label_text">Conditions</div>
            <ng-container *ngFor="let item of faqObj.conditions;  let index = index">
              <div class="condition-view-mode-data">
                <span class="default-data and-rule" *ngIf="index > 0">And</span>
                <span class="tag-name">{{item.contextType}}</span>
                <span class="tag-name">{{item.contextCategory}}</span>
                <span class="default-data">{{item.operator}}</span>   
                <span class="tag-name" *ngFor="let value of item.value">{{value}}</span>
              </div>
            </ng-container>
          </div>
          <ng-container *ngIf="(faqObj && faqObj.answerType === 'condition') && (currentEditIndex === index)">
           <div class="conditional-sec-new">
              <div class="label-text mb-2">Conditions</div>
              <div class="input-conditions col-12">
                <ng-container *ngFor="let ruleObj of faqObj.conditions; let conditionIndex = index">
                    <div class="d-flex align-items-center w-100 mb-13">
                        <div class="input-bg-sec">
                            <div class="row m-0 search-content-sec">
                                <div class="col-2 p-0 title">
                                    Select Context
                                </div>
                                <div class="col-10 pr-0">
                                    <div class="kr-sg-dropdowns w-auto">                           
                                        <div class="dropdown dropdown-open">
                                            <button class="dropdown-toggle dropdown-input" data-toggle="dropdown">{{'businessRules.' +  ruleObj.contextType | translate}}</button>                                            
                                            <ul class="dropdown-menu content-menu">                                                                          
                                            <li *ngFor="let contextType of ruleOptions.contextTypes" (click)="ruleSelection(ruleObj,contextType,'contextType')"><a>{{'businessRules.' + contextType | translate}}</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row m-0 setparameetres-sec">
                                <div class="col-2 p-0 title">
                                  Set Criteria
                                </div>
                                <div class="tags row m-0 col-10">
                                    <div class="chip-sys-data">                      
                                    <mat-form-field  class="example-chip-list" [floatLabel]="'never'">
                                        <mat-chip-list #chipList [attr.aria-label]="'tag selection'">
                                        <ng-container>
                                            <mat-chip  [selectable]="selectable" class="dropdownDiv" [ngClass]="{'activeDrop': currentEditInex === index}">                                       
                                                <div class="kr-sg-dropdowns d-inline-block w-auto" ngbDropdown (click)='currentEditInex = index'>
                                                    <div class="dropdown dropdown-open">
                                                        <button class="dropdown-toggle dropdown-input" id="dropdownBasic1" ngbDropdownToggle>{{'businessRules.' + ruleObj.contextCategory | translate}}</button>
                                                        <ul class="dropdown-menu content-menu faq-filter-add" ngbDropdownMenu>
                                                            <li ngbDropdownItem *ngFor="let contextCategory of ruleOptions[ruleObj.contextType]" (click)="ruleSelection(ruleObj,contextCategory,'contextCategory')">{{'businessRules.' +  contextCategory | translate}}</li>
                                                        </ul>
                                                    </div>                                            
                                                </div>
                                            </mat-chip> 
                                        </ng-container>
                                        <ng-container>
                                            <mat-chip [selectable]="selectable" class="dropdownDiv" [ngClass]="{'activeDrop': currentEditInex === index}">
                                                <div class="kr-sg-dropdowns d-inline-block w-auto" ngbDropdown (click)='currentEditInex = index'>
                                                    <div class="dropdown dropdown-open">
                                                        <button class="dropdown-toggle dropdown-input" id="dropdownBasic1" ngbDropdownToggle>{{'businessRules.' + ruleObj.operator | translate}}</button>
                                                        <ul class="dropdown-menu content-menu faq-filter-add" ngbDropdownMenu>
                                                            <li ngbDropdownItem *ngFor="let operator of conditions" (click)="ruleSelection(ruleObj,operator,'operator')">{{'businessRules.' + operator | translate}}</li>
                                                        </ul>
                                                    </div>                                            
                                                </div>                             
                                            </mat-chip> 
                                        </ng-container>
                                        <ng-container *ngFor="let value of ruleObj.value">
                                            <mat-chip  [selectable]="selectable" (removed)="removeTag(ruleObj.value,tag)"><span class="mat-val" *ngIf="value">{{value}}</span>
                                                    <mat-icon matChipRemove><img src="assets/images/close.svg"></mat-icon>
                                            </mat-chip> 
                                        </ng-container>
                                        <input placeholder="Type Alternatives and Press Enter"
                                                [matChipInputFor]="chipList"
                                                [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                                                (matChipInputTokenEnd)="addRules($event,ruleObj,i)"  #suggestedInput>
                                        </mat-chip-list>
                                    </mat-form-field>
                                    </div>
                                </div>                    
                            </div>
                        </div>
                        <div class="delete-rule" (click)='removeRule(ruleIndex,faqObj.conditions)'>
                            <img src="assets/icons/modal-close.svg">
                        </div> 
                    </div>                                
                </ng-container>               
              </div> 
           </div>
            <div class="add-condition" (click)="addNewRule(index,faqObj)"><img src="assets/icons/plus-blue.svg">Add Condition</div>
          </ng-container>
        </div>
      </div>
    </div>
    <div class="responseEditorContainer" *ngIf="currentEditIndex === index">
      <div class="top-sec d-flex">
        <div class="col-6 left_sec">
          <div class="tabs-sec">
            <span class="tab-title " (click)="faqObj.type='string'" [ngClass]="{'active': faqObj.type === 'string'}">Editor</span>
            <span class="tab-title" (click)="faqObj.type='javascript'" [ngClass]="{'active': faqObj.type==='javascript'}">&lt;/&gt; CODE</span>
            <span class="tab-title d-none" (click)="faqObj.type='external'" [ngClass]="{'active': faqObj.type==='external'}">External</span>
          </div>
        </div>
        <div class="col-6 right-sec">
          <div class="tabs-sec border-0">
            <span class="tab-title pl-0">Response Preview</span>
          </div>
        </div>
      </div>
      <div class="bottom_sec d-flex">
        <div class="col-6 left_sec">        
          <div class="content-data">
            <div class="bot_rsponse_advance_mode">
              <div class="layout-select">
                <div class="d-flex align-items-center m-0 col-10 p-0">
                  <div class="title">Select Layout</div>
                  <div class="img-block" (click)="setResponseType('default',faqObj)" [ngClass]="{'active': (faqObj.responseType === 'default') || (!faqObj.responseType)}">
                    <img *ngIf="(faqObj.responseType !== 'default')" src="assets/icons/editor/no-image.svg">
                    <img  *ngIf="(faqObj.responseType === 'default')" src="assets/icons/editor/no-image-active.svg">
                  </div>
                  <div class="img-block" (click)="setResponseType('horizontalSplit',faqObj)"  [ngClass]="{'active': (faqObj.responseType === 'horizontalSplit')}">
                    <img *ngIf="(faqObj.responseType !== 'horizontalSplit')" src="assets/icons/editor/image-horizantal.svg">
                    <img *ngIf="(faqObj.responseType === 'horizontalSplit')" src="assets/icons/editor/image-horizantal-active.svg" >
                  </div>
                  <div class="img-block" (click)="setResponseType('verticalSplit',faqObj)"  [ngClass]="{'active': (faqObj.responseType === 'verticalSplit')}">
                    <img *ngIf="(faqObj.responseType !== 'verticalSplit')" src="assets/icons/editor/image-vertical.svg">
                    <img *ngIf="(faqObj.responseType == 'verticalSplit')" src="assets/icons/editor/image-vertical-active.svg" >
                  </div>
                </div>
              </div>
              <img src="assets/icons/sidemenu/delete-table.svg" class="delete-response hide">
            </div>    
            <ng-container *ngTemplateOutlet="botResponse; context{$implicit: faqResponse,responses:faqResponse.defaultAnswers,responseObj:faqObj,reponseType:'default',id:'default_',index:index }"> </ng-container>
          </div>
        </div>
        <div class="col-6 right_sec">        
          <div class="content-data">
            <div class="responsePreviewBlock">
              <perfect-scrollbar>
                <ng-container *ngTemplateOutlet="botResponsePreview; context{$implicit: faqResponse,responses:faqResponse.defaultAnswers,responseObj:faqObj,reponseType:'default',id:'default_',index:index }"> </ng-container>
              </perfect-scrollbar>
            </div>
          </div>
        </div>
      </div>      
    </div>
    <div class="col-12 p-0 pointer body_sec" title="Click to edit this response" *ngIf="currentEditIndex !== index">
       <ng-container *ngTemplateOutlet="botResponsePreview; context{$implicit: faqResponse,responses:faqResponse.defaultAnswers,responseObj:faqObj,reponseType:'default',id:'default_',index:index }"> </ng-container>
    </div>
  </ng-container>
  <div class="btn-sec">
    <div class="left-btns">
      <button class="kr-sg-button-secondary btn_lg mr-0" (click)="addAnotherResponse('default')"><img src="assets/icons/editor/plus-add.svg" class="mr-2" >Add Bot Response</button>
    </div>
  </div>
  <div class="btn-sec" *ngIf="!faqData && false">
    <div class="left-btns">
      <button class="kr-sg-button-primary btn_lg" (click)="save()">{{loading ? 'Saving..' : 'Save'}}</button>
      <button class="kr-sg-button-secondary btn_lg" (click)="cancel()">Cancel</button>
    </div>
    <div class="right-btns">        
      <button class="kr-sg-button-secondary btn_lg mr-0" (click)="addAnotherResponse('default')"><img src="assets/icons/editor/plus-add.svg" class="mr-2" >Add Bot Response</button>
      <!-- <button class="kr-sg-button-tertiary"  *ngIf="!isFollowUp" (click)='addAltQues()'>Add Alternate Question</button>
      <button class="kr-sg-button-tertiary"  *ngIf="!isFollowUp" (click)='addFollowupQues()'>Add Followup Question</button> -->
    </div>
  </div>
  <hr>
  <div class="add-alternative-questions row" *ngIf="!isFollowUp && faqData">
    <div class="col-10 pl-0 pr-2">
        <div class="question-name text-truncate">Alternate Questions
            <span *ngIf="faqData">{{faqData._source.alternateQuestions?.length>0?'('+faqData._source.alternateQuestions?.length+')':''}}</span>
            <!-- ({{(selectedFaq.alternateQuestions?selectedFaq.alternateQuestions.length:0)}}) -->
        </div>
        <div class="added-tags text-truncate">Add alternate forms of the question, key tags and add synonyms.</div>
    </div>
    <div class="col-2 p-0 text-right" *ngIf="!isAdd">
        <button class="kr-sg-button-primary btn_lg" (click)="addAltQues()">Add</button>
    </div>
  </div>
  <div *ngIf="isAdd" class="alternative-question-results">
      <app-add-alternate-question [faqServ]="faqServiceAlt"></app-add-alternate-question>
  </div>
  <div class="btn-sec mt-0" *ngIf="isAdd">
    <div class="left-btns another_question_btn">
      <button class="kr-sg-button-secondary btn_lg mr-0" (click)="addAnotherAlternate()"><img src="assets/icons/editor/plus-add.svg" class="mr-2" >Another Question</button>
    </div>
  </div>
  <ng-container *ngIf="faqData && faqData._source && faqData._source.alternateQuestions?.length">
  <div class="added-questions-list mt-2" *ngFor="let alternateQuestion of faqData._source?.alternateQuestions; let alterIndex = index">
      <div class="question-name text-truncate">{{alternateQuestion.question}}</div>
      <div class="added-tags text-truncate">
          <span class="tags-data" *ngFor="let keyword of alternateQuestion?.keywords">#{{keyword.keyword}}&nbsp;</span>
      </div>
      <img src="assets/icons/delete-table.svg"  (click)="delAltQues(alternateQuestion,alterIndex)" class="delete-icon cursor-pointer" [ngClass]="{'pos-trash': alternateQuestion?.keywords?.length == 0}">
  </div>
  </ng-container>
</div>

<kr-modal modalType="default" #createImagePop>
  <div class="modal-header">
        <h4 class="modal-title">Provide Image URL</h4>
      </div>
      <div class="modal-body textAlignLeft">
        <div class="kr-sg-input-text mb-3">
          <div class="label-text">URL</div>
          <input maxlength="5128" type="text" autocomplete="off" placeholder="Enter Url" class="input-text" [(ngModel)]="imgInfo.url" name="appName">
        </div>
        <div class="kr-sg-input-text mb-3">
          <div class="label-text">Name</div>
          <input maxlength="128" type="text" autocomplete="off" placeholder="Enter Name" class="input-text" [(ngModel)]="imgInfo.alt" name="appName">
        </div>
      </div>
      <div class="modal-footer">
        <button [disabled]="!imgInfo.url"  type="button" class="btn kr-btn-primary"  data-dismiss="modal" (click)='addImage()' >Add</button>
        <button type="button" class="btn kr-btn-cancel" data-dismiss="modal" (click)="closeImgApp()">Close</button>
      </div>
</kr-modal>
<kr-modal modalType="default" #createLinkPop>
  <div class="modal-header">
        <h4 class="modal-title">Provide link URL</h4>
      </div>
      <div class="modal-body textAlignLeft">
        <div class="kr-sg-input-text mb-3">
          <div class="label-text">URL</div>
          <input maxlength="1024" type="text" autocomplete="off" placeholder="App name" class="input-text" [(ngModel)]="linkInfo.link" name="LinkURL">
        </div>
        <div class="kr-sg-input-text mb-3">
          <div class="label-text">Link Text</div>
          <input maxlength="1024" type="text" placeholder="Enter Link Trxt" autocomplete="off" class="input-text" [(ngModel)]="linkInfo.linkText" name="LinkText">
        </div>
      </div>
      <div class="modal-footer">
        <button [disabled]="!linkInfo.link"  type="button" class="btn kr-btn-primary"  data-dismiss="modal" (click)='saveLink()' >Save</button>
        <button type="button" class="btn kr-btn-cancel" data-dismiss="modal" (click)="closeLinkApp()">Close</button>
      </div>
</kr-modal>

<kr-modal modalType="default" #externalResponsePop modalClass="modal_popups_">
  <div class="modal-header">
    <div class="title">External</div>
    <div class="close_icon"><img class="ng-tns-c11-2" (click)="closeExternalPopUpRef()" src="assets/icons/modal-close.svg"></div>
  </div>
<perfect-scrollbar class="perfect-scroll-modal-body">
  <div class="modal-body textAlignLeft">
    <div>It is extremely important that you keep your contact information on your account updated at all times. To update your address, phone numbers and email address, please login to your account and edit your contact details under the “Your Contact Details” link on the left navigation. To make changes to your account, you will also need to enter an Online Authorization Code (OAC) that will be sent to your registered mobile phone on your account and to your registered email address to authenticate this transaction.</div>
   </div>
</perfect-scrollbar> 
  <div class="modal-footer text-left">
      <button class="kr-sg-button-secondary btn_lg" (click)="closeExternalPopUpRef()">Close</button>
  </div>
</kr-modal>