<div class="business-rules-wrapper">
    <div class="header-sec col-12 row m-0">
        <div class="col-4 lef-sec p-0" *ngIf="!(selcectionObj && selcectionObj.selectedItems && selcectionObj.selectedCount)"><span class="title">Business Rules</span></div>
        <div class="col-4 lef-sec p-0" *ngIf="selcectionObj && selcectionObj.selectedItems && selcectionObj.selectedCount">
            <div class="selected-count" *ngIf="!selcectionObj.selectAll">
                <span class="outer-border">
                    <span class="inner-bg"></span>
                </span>
                {{selcectionObj.selectedCount}} {{'businessRules.rules_selected' | translate}}
            </div>
            <div class="kr-sg-checkbox m-0" *ngIf="selcectionObj.selectAll">
                <input id="checkbox-1" class="checkbox-custom" type="checkbox" checked>
                <label for="checkbox-1" class="checkbox-custom-label"></label>
                <span class="allselected">{{'businessRules.all_rules_selected' | translate}}</span>
            </div>
        </div>
        <div class="col-8 right-sec p-0"  *ngIf="!(selcectionObj && selcectionObj.selectedItems && selcectionObj.selectedCount)">
            <div class="kr-sg-input-search m-0 " [ngClass]="{'active': showSearch}">                               
                <input type="text" placeholder="Search" id='searchInput' autocomplete="off" class="input-search" placeholder="Search" [(ngModel)]="searchRules">           
            </div> 
            <div class="seach-block" (click)="toggleSearch()"><img *ngIf="!showSearch" src="assets/icons/search.svg"><img *ngIf="showSearch" src="assets/images/close.svg">{{'search' | translate}}
            </div>
            <div class="add_feild" (click)="createNewRule()">
                <img src="assets/icons/add_plus.svg">{{'businessRules.add_rule' | translate}}
            </div>
            <div class="clock d-none"><img src="assets/icons/clock.svg"></div>
        </div>
        <div class="col-8 right-sec p-0" *ngIf="selcectionObj && selcectionObj.selectedItems && selcectionObj.selectedCount">
            <button class="kr-sg-button-danger btn_lg" (click)='deleteMultiePop()'>{{'delete' | translate}}</button>
        </div>
    </div>
    <div class="table_section">
        <div class="header_sec row m-0">
            <div class="col-3 content withcheckbox">
                <div class="kr-sg-checkbox p-0 m-0">
                    <input id="selectAllRules" class="checkbox-custom" type="checkbox" (change)="selectAll()" [(ngModel)]="selcectionObj.selectAll">
                    <label for="selectAllRules" class="checkbox-custom-label"></label>
                </div>
                <div class="title"><img src="assets/icons/sort_up_down.svg" class="pr-1">{{'name_caps' | translate}}</div>
            </div>
            <div class="col-3 content">
                <img ng src="assets/icons/sort_up_down.svg" class="pr-1">
                <img src="assets/icons/sort_up_down.svg" class="pr-1">
                {{'businessRules.condition_caps' | translate}}</div>
            <div class="col-3 content"><img src="assets/icons/sort_up_down.svg" class="pr-1">{{'businessRules.outcome_caps' | translate}}</div>
            <div class="col-3 content"><img src="assets/icons/sort_up_down.svg" class="pr-1">{{'businessRules.status_caps' | translate}}</div>
        </div>
        <perfect-scrollbar class="scroll_table">                     
            <div class="body_sec row m-0" *ngFor="let ruleObj of rules | filter: [ searchRules, 'ruleName']" [ngClass]="{'selected': (selcectionObj && selcectionObj.selectedItems && selcectionObj.selectedItems[ruleObj._id])}">
                <div class="col-3 content withcheckbox">                   
                    <div class="kr-sg-checkbox p-0 m-0">
                        <input id="{{ruleObj._id}}" class="checkbox-custom selectRuleCheckBoxDiv" type="checkbox" (change)="checkUncheckfacets(ruleObj)">
                        <label for="{{ruleObj._id}}" class="checkbox-custom-label"></label>
                    </div>
                    <div class="title">{{ruleObj.ruleName}}</div>
                </div>
                <div class="col-3 content">
                    <ng-container *ngFor="let rule of ruleObj.rules; let ruleIndex = index">
                    <span class="divider mr-1 mb-1" *ngIf="ruleIndex > 0">{{'and_caps' | translate}}</span> 
                    <span class="tags-input mr-1 mb-1"><span class="small-text">{{rule.contextType}} :</span> {{rule.contextCategory}}</span>
                    <span class="outer-name mr-1 mb-1">{{rule.operator}}</span>
                    <ng-container *ngFor="let value of rule.value; let valueIndex = index">
                    <span class="tags-input mr-1 mb-1" >{{value}}</span>
                    <span class="divider mr-1 mb-1" *ngIf="valueIndex < (rule.value.length-1)">{{'or_caps' | translate}}</span>
                    </ng-container>
                  </ng-container>
                </div>
                <div class="col-3 content">
                    <ng-container *ngFor="let outcome of ruleObj.outcomes">
                        <span class="tags-input mr-1 mb-1">{{outcome.scale}}x BoostResult</span>
                        <span class="outer-name mr-1 mb-1">{{outcome.outcomeOperator}}</span>
                        <span class="tags-input mr-1 mb-1">{{outcome.outcomeType}}: 
                            <span *ngFor="let value of outcome.outcomeValue">{{value}}</span>
                        </span>
                    </ng-container>
                </div>
                <div class="col-3 content actions">
                   <span class="active-status" *ngIf="ruleObj.isRuleActive"><span class="indication"></span>{{'active' | translate}}</span>
                   <span class="in-active-status" *ngIf="!ruleObj.isRuleActive"><span class="indication"></span>{{'In-Active' | translate}}</span>
                   <div class="actions-icons">
                       <img src="assets/images/edit-pencil.svg" (click)='editRule(ruleObj)'>
                       <img src="assets/icons/delete-table.svg" (click)="deleteRulePop()">
                   </div>
                </div>
            </div>  
            <div class="divBlockEmptylastChild text-center">         
                <div class="desc">No search results found</div>
            </div> 
        </perfect-scrollbar>
    </div>
</div>


<kr-modal modalType="center" #addBusinessRules modalClass="modal_popups_ business-rules-popup">
  <div class="modal-header">
    <div class="title font-weight-bold">{{'businessRules.add_rule' | translate}}</div>
    <label class="kr-sg-toggle toggle-switch">                                       
        <input type="checkbox" [(ngModel)]="addEditRuleObj.isRuleActive">
        <div class="slider"><span class="enabled">{{'businessRules.rule_active' | translate}}</span><span class="disabled">{{'businessRules.rule_in_active' | translate}}</span></div>
    </label>  
    <div class="close_icon" (click)="closeModalPopup()"><img class="ng-tns-c11-2" src="assets/icons/modal-close.svg"></div>
  </div>
  <perfect-scrollbar class="perfect-scroll-modal-body">
    <div class="modal-body">
        <div class="kr-sg-input-text mb-5">
            <div class="label-text">{{'businessRules.rule_name' | translate}}</div>
            <input type="text" placeholder="Rule Name" class="input-text" [(ngModel)]="addEditRuleObj.ruleName">           
        </div>
        <div class="rules-block row">
            <div class="condition-add-text col-3 pl-0 pr-4">
                <div class="title">{{'businessRules.condition' | translate}}</div>
                <div class="desc_text">{{ 'businessRules.condition_desc' | translate }}</div>
                <div class="add-condition" (click)="addNewRule()"><img src="assets/icons/plus-blue.svg">Add Condition</div>
            </div>
            <div class="input-conditions col-9">
                <ng-container *ngFor="let ruleObj of rulesArrayforAddEdit; let ruleIndex = index">
                    <div class="d-flex align-items-center w-100 mb-13">
                        <div class="input-bg-sec">
                            <div class="row m-0 search-content-sec">
                                <div class="col-2 p-0 title">
                                    Select Context
                                </div>
                                <div class="col-10 pr-0">
                                    <div class="kr-sg-dropdowns w-auto">                           
                                        <div class="dropdown dropdown-open">
                                            <button class="dropdown-toggle dropdown-input" data-toggle="dropdown">{{'businessRules.' +  ruleObj.contextType | translate}}</button>                                            
                                            <ul class="dropdown-menu content-menu">                                                                          
                                            <li *ngFor="let contextType of ruleOptions.contextTypes" (click)="ruleSelection(ruleObj,contextType,'contextType')"><a>{{'businessRules.' + contextType | translate}}</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row m-0 setparameetres-sec">
                                <div class="col-2 p-0 title">
                                    Set Parameters
                                </div>
                                <div class="tags row m-0 col-10">
                                    <div class="chip-sys-data">                      
                                    <mat-form-field  class="example-chip-list" [floatLabel]="'never'">
                                        <mat-chip-list #chipList [attr.aria-label]="'tag selection'">
                                        <ng-container>
                                            <mat-chip  [selectable]="selectable" class="dropdownDiv">                                       
                                                <div class="kr-sg-dropdowns d-inline-block w-auto" ngbDropdown>
                                                    <div class="dropdown dropdown-open">
                                                        <button class="dropdown-toggle dropdown-input" id="dropdownBasic1" ngbDropdownToggle>{{'businessRules.' + ruleObj.contextCategory | translate}}</button>
                                                        <ul class="dropdown-menu content-menu faq-filter-add" ngbDropdownMenu>
                                                            <li ngbDropdownItem *ngFor="let contextCategory of ruleOptions[ruleObj.contextType]" (click)="ruleSelection(ruleObj,contextCategory,'contextCategory')">{{'businessRules.' +  contextCategory | translate}}</li>
                                                        </ul>
                                                    </div>                                            
                                                </div>
                                            </mat-chip> 
                                        </ng-container>
                                        <ng-container>
                                            <mat-chip [selectable]="selectable" class="dropdownDiv">
                                                <div class="kr-sg-dropdowns d-inline-block w-auto" ngbDropdown>
                                                    <div class="dropdown dropdown-open">
                                                        <button class="dropdown-toggle dropdown-input" id="dropdownBasic1" ngbDropdownToggle>{{'businessRules.' + ruleObj.operator | translate}}</button>
                                                        <ul class="dropdown-menu content-menu faq-filter-add" ngbDropdownMenu>
                                                            <li ngbDropdownItem *ngFor="let operator of conditions" (click)="ruleSelection(ruleObj,operator,'operator')">{{'businessRules.' + operator | translate}}</li>
                                                        </ul>
                                                    </div>                                            
                                                </div>                             
                                            </mat-chip> 
                                        </ng-container>
                                        <ng-container *ngFor="let value of ruleObj.value">
                                            <mat-chip  [selectable]="selectable" [removable]="removable"><span class="mat-val" *ngIf="value">{{value}}</span>
                                                    <mat-icon matChipRemove><img src="assets/images/close.svg"></mat-icon>
                                            </mat-chip> 
                                        </ng-container>
                                        <input placeholder="Type Alternatives and Press Enter"
                                                [matChipInputFor]="chipList"
                                                [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                                                (matChipInputTokenEnd)="addRules($event,ruleObj,i)"  #suggestedInput>
                                        </mat-chip-list>
                                    </mat-form-field>
                                    </div>
                                </div>                    
                            </div>
                        </div>
                        <div class="delete-rule" (click)='removeRule(ruleIndex)'>
                            <img src="assets/icons/modal-close.svg">
                        </div> 
                    </div>                                
                </ng-container>               
            </div>                   
        </div>        
        <div class="rules-block row">
            <div class="condition-add-text col-3 pl-0 pr-4">
                <div class="title">{{'businessRules.outcome_caps_small' | translate}}</div>
                <div class="desc_text">{{ 'businessRules.condition_desc_outcome' | translate }}</div>
                <div class="add-condition" (click)="addNewOutcome()"><img src="assets/icons/plus-blue.svg">Add Outcome</div>
            </div>
            <div class="input-conditions col-9">
                <ng-container *ngFor="let outcomeObj of outcomeArrayforAddEdit; let index = index">
                    <div class="d-flex align-items-center w-100 mb-13">
                        <div class="input-bg-sec">
                            <div class="row m-0 action-scontent-sec">
                                <div class="col-2 p-0 title">
                                    Action
                                </div>
                                <div class="col-10 row m-0 align-items-center right-side-sec pr-0">
                                    <div class="kr-sg-dropdowns col-4 pl-0">                           
                                        <div class="dropdown dropdown-open">
                                            <button class="dropdown-toggle dropdown-input" data-toggle="dropdown">{{'businessRules.' + outcomeObj.outcomeType | translate}}</button>                                            
                                            <ul class="dropdown-menu content-menu">                                                                          
                                            <li *ngFor="let outcomeType of ruleOptions.actions" (click)="outcomeSclection(outcomeObj,outcomeType,'outcomeType')"><a>{{'businessRules.' + outcomeType | translate}}</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-4 pr-0">
                                        <app-range-slider [customClass]='"weightsSlider"' [allData]='outcomeObj.sliderObj' (valueEvent)="valueEvent($event,outcomeObj)"></app-range-slider>
                                    </div>
                                    <div class="col-4 pr-0 text-right">
                                        <span class="result-slider-title">{{'businessRules.boostResults' | translate}}</span>
                                        <span class="slider-count">{{outcomeObj.scale}}X</span>
                                    </div>
                                </div>
                            </div>
                            <div class="row m-0 response-content-sec">
                                <div class="col-2 p-0 title">
                                    Response
                                </div>
                                <div class="tags row m-0 col-10">
                                    <div class="chip-sys-data">                      
                                    <mat-form-field  class="example-chip-list" [floatLabel]="'never'">
                                        <mat-chip-list #chipList [attr.aria-label]="'tag selection'">
                                        <ng-container *ngIf="outcomeObj.fieldName">
                                            <mat-chip  [selectable]="selectable" class="selectedFiledBlock">
                                            <span>{{outcomeObj.fieldName}}</span>
                                            </mat-chip> 
                                        </ng-container>
                                        <ng-container *ngIf="outcomeObj.fieldName">
                                            <mat-chip  [selectable]="selectable" class="dropdownDiv">                                           
                                                <div class="kr-sg-dropdowns d-inline-block w-auto" ngbDropdown container='body'>
                                                    <div class="dropdown dropdown-open">
                                                        <button class="dropdown-toggle dropdown-input" id="dropdownBasic1" ngbDropdownToggle>{{('businessRules.' + outcomeObj.outcomeOperator) | translate}}</button>
                                                        <ul class="dropdown-menu content-menu faq-filter-add" ngbDropdownMenu>
                                                            <li ngbDropdownItem *ngFor="let operator of conditions" (click)="outcomeSclection(outcomeObj,operator,'outcomeOperator')">{{('businessRules.' + operator) | translate}}</li>
                                                        </ul>
                                                    </div>                                            
                                                </div>  
                                            </mat-chip> 
                                        </ng-container>
                                        <ng-container *ngFor="let value of outcomeObj.outcomeValue">
                                            <mat-chip   [selectable]="selectable" [removable]="removable"><span class="mat-val" *ngIf="value">{{value}}</span>
                                                        <mat-icon matChipRemove><img src="assets/images/close.svg"></mat-icon>
                                            </mat-chip> 
                                        </ng-container>
                                        <input [placeholder]="outcomeObj.fieldName?'Type and Press Enter':'Type and select field'"
                                                [matChipInputFor]="chipList"
                                                (keyup)="getFieldAutoComplete($event,outcomeObj)"
                                                [matAutocomplete]="suggestedItems"
                                                [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                                                (matChipInputTokenEnd)="addOutcome($event,outcomeObj,i)"  #suggestedInput>
                                        </mat-chip-list>
                                        <mat-autocomplete #suggestedItems="matAutocomplete" (optionSelected)="selectedTag($event,outcomeObj)" >
                                            <ng-container *ngFor = "let suggestion of fieldAutoSuggestion">
                                            <mat-option [value]="suggestion">
                                                {{suggestion.fieldName}}
                                            </mat-option>
                                            </ng-container>
                                        </mat-autocomplete>
                                    </mat-form-field>
                                    </div>
                                </div>                            
                            </div>
                        </div>
                        <div class="delete-rule" (click)='removeOutcome(index)'>
                            <img src="assets/icons/modal-close.svg">
                        </div>
                    </div>                    
                 </ng-container>
            </div>                  
        </div>
    </div>
  </perfect-scrollbar>
  <div class="modal-footer">
    <button class="kr-sg-button-primary btn_lg" *ngIf="addEditRuleObj._id" [disabled]="!addEditRuleObj.ruleName" (click)="updateRule(addEditRuleObj)">Proceed</button>
      <button class="kr-sg-button-primary btn_lg" *ngIf="!addEditRuleObj._id" [disabled]="!addEditRuleObj.ruleName" (click)="createRule()">Proceed</button>
      <button class="kr-sg-button-secondary btn_lg" (click)="closeModalPopup()">Back</button>
  </div>
</kr-modal> 