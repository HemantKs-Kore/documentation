<div class="mainLoadingSpinner" *ngIf="pageLoading">
  <mat-spinner diameter="18" strokeWidth="2"></mat-spinner>
  <span class="please-wait-message">{{'Please Wait!' | translate}}</span>
</div>
<div class="pricing-container-wrapper" *ngIf="(currentSubscriptionPlan?.subscription)">
  <div class="title-header d-flex align-items-center justify-content-between">
    <div>{{"plan.plan_head"| translate}}</div>
    <div class="btns-block">
    <button class="kr-sg-button-secondary btn_lg mr-2" *ngIf="(currentSubscriptionPlan?.subscription?.planName|lowercase)!=='free'&&(currentSubscriptionPlan?.subscription?.changesScheduledFor==='none')" (click)="cancelSubscriptionModal('open')"><i class="si-minus-circle-o"></i>Cancel Subscription</button>
    <button class="kr-sg-button-primary btn_lg" [ngClass]="{'d-none':(currentSubscriptionPlan?.subscription?.planName|lowercase)==='enterprise'}" (click)="selectModal('choose_plan')"><i class="si-publish si-icon"></i>Upgrade Plan</button>
    <button class="kr-sg-button-primary btn_lg" [ngClass]="{'d-none':(currentSubscriptionPlan?.subscription?.planName|lowercase)!=='enterprise'}" (click)="selectModal('choose_plan')"><img src="assets/icons/pricing/move_down.png">  Downgrade Plan</button>
    <!-- <button (click)="revertCancelModal('open')">Revert cancel</button>   -->
  </div>
  </div>
    <div class="info-note proInfo row m-0" *ngIf="(bannerObj?.show)" [ngClass]="{'proInfoSuccess':bannerObj.type==='success','proInfoError':bannerObj.type==='failed','proInfoInfo':bannerObj.type==='downgrade','downGradeAlert':bannerObj.type==='downgrade'}">
      <div class="col-10 d-flex align-items-center p-0">
        <span class="info-proTip-icon">
          <i class="si-check-round" *ngIf="bannerObj?.type==='success'"></i>
          <i class="si-warning" *ngIf="bannerObj?.type==='failed'"></i>
          <i class="si-info" *ngIf="bannerObj.type==='downgrade'"></i>
        </span>
        <span class="info-text">{{bannerObj?.msg}}</span>
      </div>
      <div class="close-info col-2 text-right">
        <span class="cancel-request" *ngIf="bannerObj.type==='downgrade'" (click)="revertCancel()">Cancel request</span>
        <span class="info-proTip-close" (click)="clearBanner()"><i class="si-close"></i></span>
      </div>
    </div>
  <perfect-scrollbar class="pricing-scroll">
    <div class="pricing-details-main-sec">
       <div class="row col-12 m-0 tile-block">
          <div class="col-4 tile-left">
            <div class="tile-header">
              <span class="pr-1"><i class="si-instructions"></i></span>  Current Plan details
            </div>
            <div class="tile-plan-overview">

              <div class="tile-current-plan">
                <div class="tile-plan-details">
                  <div class="plan-type">{{currentSubscriptionPlan?.subscription?.planName|uppercase}} PLAN  <i class="si-info"></i></div> 
                  <div class="plan-price">
                   <span class="plan-crown-img" *ngIf="(currentSubscriptionPlan?.subscription?.planName|lowercase)!=='free'"><img src="assets/images/pricing-plan/plan-crown.svg" /></span> <span *ngIf="currentSubscriptionPlan?.subscription?.planAmount>=0">$</span>{{currentSubscriptionPlan?.subscription?.planAmount>=0?(currentSubscriptionPlan?.subscription?.planAmount):'CUSTOM '}} <span class="plan-duration" *ngIf="currentSubscriptionPlan?.subscription?.planAmount>0||((currentSubscriptionPlan?.subscription?.planName|lowercase)==='enterprise')">/ {{currentSubscriptionPlan?.subscription?.billingUnit}}</span>
                  </div>
                  <div class="plan-options">
                    <div class="plan-view">
                      <button class="kr-sg-button-ghost btn_md" data-toggle="modal" data-target="#viewPlanModal">View Plan <span><i class="si-carrotup angle-right-icon"></i></span></button>
                    </div>
                    <div class="plan-change">
                      <button class="kr-sg-button-ghost btn_md" (click)="selectModal('choose_plan')">Change Plan <span><i class="si-carrotup angle-right-icon"></i></span></button>
                    </div>
                  </div>
                </div>
                <div class="tile-plan-status" [ngClass]="{'plan-status-active':currentSubscriptionPlan?.subscription?.changesScheduledFor==='none','plan-status-cancel':currentSubscriptionPlan?.subscription?.changesScheduledFor==='cancel','plan-status-downgrade':currentSubscriptionPlan?.subscription?.changesScheduledFor==='downgrade','d-block':(currentSubscriptionPlan?.subscription?.changesScheduledFor==='downgrade')}">
                  <!--cancel subscription buttons-->
                  <div class="plan-subscription" *ngIf="['none','cancel'].includes(currentSubscriptionPlan?.subscription?.changesScheduledFor)"><span class="plan-current-status"></span>{{(currentSubscriptionPlan?.subscription?.changesScheduledFor==='none')?("plan.active" | translate):("plan.cancel_request_sent" | translate)}}</div>
                  <div class="plan-subscription-duration" *ngIf="currentSubscriptionPlan?.subscription?.changesScheduledFor==='none'">{{(currentSubscriptionPlan?.subscription?.planName|lowercase)!=='free'?'Till  ':''}}{{(currentSubscriptionPlan?.subscription?.planName|lowercase)==='free'?'Forever':currentSubscriptionPlan?.subscription?.endDate|dateFormatPipe:'D.MMM.YYYY'}}</div>
                  <div class="plan-subscription-duration" *ngIf="['cancel'].includes(currentSubscriptionPlan?.subscription?.changesScheduledFor)" (click)="revertCancel()">{{"plan.revert_cancellation_btn" | translate}}</div>
                  <!--downgrade buttons-->

                  <ng-container *ngIf="(currentSubscriptionPlan?.subscription?.changesScheduledFor==='downgrade')">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="plan-downgrade" *ngIf="(currentSubscriptionPlan?.subscription?.changesScheduledFor==='downgrade')"><span class="plan-current-status"></span>Downgraded</div>
                      <div class="plan-downgrade-duration" *ngIf="(currentSubscriptionPlan?.subscription?.changesScheduledFor==='downgrade')">Billing cycle {{currentSubscriptionPlan?.subscription?.endDate|dateFormatPipe:'D.MM.YY'}}</div>  
                    </div>
                   <div class="plan-downgrade-cancel" *ngIf="['downgrade'].includes(currentSubscriptionPlan?.subscription?.changesScheduledFor)" (click)="revertCancel()">{{"plan.cancel_request" | translate}}</div>
                  </ng-container>

                </div>
              </div>

              <div class="tile-plan-utilization plan-current-usage">
                <div class="plan-current-and-overage">
                  <div class="plan-current-usage">CURRENT USAGE</div>
                </div>
                <div class="plan-progress-bar-block">
                  <div class="plan-progress-bar-header-block">
                    <div class="plan-progress-bar-header">Documents</div>
                    <div class="plan-progress-bar-count" *ngIf="usageDetails?.ingestDocsLimit">{{usageDetails?.ingestDocsUsed}} <span class="total-count">/ {{usageDetails?.ingestDocsLimit}}</span></div>
                  </div>
                  <div class="plan-progress-bar">
                    <ngb-progressbar class="mt-3" height="10px" [type]="usageDetails?.ingestDocs?.percentageUsed>80?'danger':(usageDetails?.ingestDocs?.percentageUsed>50&&usageDetails?.ingestDocs?.percentageUsed<=80)?'warning':'primary'" [value]="usageDetails.ingestDocs?.used" [max]="usageDetails.ingestDocs?.limit"></ngb-progressbar>
                  </div>
                </div>

                <div class="plan-progress-bar-block">
                  <div class="plan-progress-bar-header-block">
                    <div class="plan-progress-bar-header">Queries</div>
                    <div class="plan-progress-bar-count" *ngIf="usageDetails?.searchQueriesLimit">{{usageDetails?.searchQueriesUsed}} <span class="total-count">/ {{usageDetails?.searchQueriesLimit}}</span></div>
                  </div>
                  <div class="plan-progress-bar">
                    <ngb-progressbar class="mt-3" height="10px" [type]="usageDetails?.searchQueries?.percentageUsed>80?'danger':(usageDetails?.searchQueries?.percentageUsed>50&&usageDetails?.searchQueries?.percentageUsed<=80)?'warning':'primary'" [value]="usageDetails.searchQueries?.used" [max]="usageDetails.searchQueries?.limit"></ngb-progressbar>
                  </div>
                </div>
              </div>

              <button class="btn btn-add-overage" [ngClass]="{'d-none':(currentSubscriptionPlan?.subscription?.planName|lowercase)==='enterprise'}" *ngIf="currentSubscriptionPlan?.overages.length===0; else overageUsage" (click)="selectModal('add_overage')"><span class="pr-2"><i class="si-grow-up-arrow"></i></span>Add Overage</button>              
              <ng-template #overageUsage>
              <div class="tile-plan-utilization plan-overview">
                <div class="plan-current-and-overage">
                  <div class="plan-current-usage">OVERAGE</div>
                  <div class="plan-add-btn">
                    <button class="kr-sg-button-ghost btn_md" (click)="selectModal('add_overage')">+ADD</button>
                  </div>
                </div>
                <div class="plan-progress-bar-block">
                  <div class="plan-progress-bar-header-block">
                    <div class="plan-progress-bar-header">Documents</div>
                    <div class="plan-progress-bar-count">{{usageDetails?.ingestDocsOverageUsed}} <span class="total-count">/ {{usageDetails?.ingestDocsOverageLimit}}</span></div>
                  </div>
                  <div class="plan-progress-bar">
                    <ngb-progressbar class="mt-3" height="10px" [type]="usageDetails?.ingestDocsUsedPercentage>80?'danger':(usageDetails?.ingestDocsUsedPercentage>50&&usageDetails?.ingestDocsUsedPercentage<=80)?'warning':'primary'" [value]="usageDetails?.ingestDocsOverageUsed" [max]="usageDetails?.ingestDocsOverageLimit"></ngb-progressbar>
                  </div>
                </div>
                <div class="plan-progress-bar-block">
                  <div class="plan-progress-bar-header-block">
                    <div class="plan-progress-bar-header">Queries</div>
                    <div class="plan-progress-bar-count">{{usageDetails?.searchQueriesOverageUsed}} <span class="total-count">/ {{usageDetails?.searchQueriesOverageLimit}}</span></div>
                  </div>
                  <div class="plan-progress-bar">
                    <ngb-progressbar class="mt-3" height="10px" [type]="usageDetails?.searchQueriesUsedPercentage>80?'danger':(usageDetails?.searchQueriesUsedPercentage>50&&usageDetails?.searchQueriesUsedPercentage<=80)?'warning':'primary'" [value]="usageDetails?.searchQueriesOverageUsed" [max]="usageDetails?.searchQueriesOverageLimit"></ngb-progressbar>
                  </div>
                </div>
              </div>
            </ng-template>
            </div>
          </div>
          <div class="col-8 tile-right">
            <div class="tile-header">
              <span class="pr-1"><i class="si-graph-lines"></i></span> Usage Metrics <span><i class="si-info"></i></span>
            </div>
            <div class="tile-chart" [ngStyle]="{'opacity':isyAxisQuerydata?'none':'0.5','pointer-events':isyAxisQuerydata?'auto':'none'}">
            <div class="title">{{"plan.query_usage_analytics"| translate}} <span>| {{monthRange}}
                ({{"plan.last_6_months"| translate}})</span></div>
            <div echarts [options]="queryGraph" class="demo-chart-graphMode" style="height: 320px;"></div>
          </div>
          </div>
        </div>
    </div>
  </perfect-scrollbar>
</div>

<!--cancel subscription modal-->
<kr-modal modalType="center" modalClass="modal_popups_ cancel_subscription_new" #cancelSubscriptionModel>
  <div class="modal-header">
    <div class="title">{{"plan.cancel_subscription"| translate}}</div>
    <div class="close_icon" (click)="cancelSubscriptionModal('close')">
      <img src="assets/icons/modal-close.svg">
    </div>
  </div>
  <perfect-scrollbar>
    <div class="modal-body">
        <div class="row col-12 m-0 cancel-subscription-block">
          <div class="col-6">
            <div class="order-img">
              <img src="assets/images/pricing-plan/plan-order/payment-hold.svg" class="order-stage-img" />
            </div>
          </div>
          <div class="col-6">
           <section class="cancel-subscription-section">
            <div class="terms-list-block">
              <div class="terms-list">
                <div class="check-icon"><i class="si-check"></i></div>
                <div>
                  Your Subscription is valid till the end of billing cycle - {{currentSubscriptionPlan?.subscription?.endDate|date:'dd MMM yyyy'}}.
                </div>
              </div>
              <div class="terms-list">
                <div class="check-icon"><i class="si-check"></i></div>
                <div>
                  Post billing cycle your app will not respond to the end users
                </div>
              </div>
              <div class="terms-list">
                <div class="check-icon"><i class="si-check"></i></div>
                <div>
                  However, you will have access to your app for 15 more days after cancellantion to either reactive or take a backup of your application. After 15 days your app will be permanently deleted.
                </div>
              </div>
            </div>
            <div class="reason-header">What is the reason you want to cancel?</div>

            <div class="reason-check-list">
              <div class="group-checkbox">
                <div class="kr-sg-checkbox d-block" *ngFor="let data of cancellationCheckboxText;let i=index">
                  <input [id]="i" class="checkbox-custom cancel-checkbox" type="checkbox" (change)="data.selected=!data.selected">
                  <label [for]="i" class="checkbox-custom-label">{{data?.name}}</label>
                </div>
              </div>
            </div>

            <div class="reason-comment">
              <div class="kr-sg-input-text-area">
                <div class="label-text">{{"plan.comments"| translate}}</div>
                <textarea placeholder="Start typing here" id="cancel_comment_text" class="input-text"></textarea>
              </div>
            </div>
           </section>
          </div>
        </div>
    </div>
  </perfect-scrollbar>
  <div class="modal-footer text-right">
    <button class="kr-sg-button-primary btn_lg" (click)="cancelSubscription()" [disabled]="btnLoader"><span class="loader-spin-inside-btn" *ngIf="btnLoader"></span>{{"plan.done"| translate}}</button>
  </div>
</kr-modal>

<!--Revert cancellation modal-->
<kr-modal modalType="center" modalClass="modal_popups_ cancel_subscription_new" #revertCancelModel>
  <div class="modal-header">
    <div class="title">Revert cancellation</div>
    <div class="close_icon" (click)="revertCancelModal('close')">
      <img src="assets/icons/modal-close.svg">
    </div>
  </div>
  <perfect-scrollbar>
    <div class="modal-body">
        <div class="row col-12 m-0 cancel-subscription-block">
          <div class="col-6">
            <div class="order-img">
              <img src="assets/images/pricing-plan/plan-order/payment-hold.svg" class="order-stage-img" />
            </div>
          </div>
          <div class="col-6">
           <section class="cancel-subscription-section">
            <div class="terms-list-block">
              <div class="terms-list">
                <div class="check-icon"><i class="si-check"></i></div>
                <div>
                  Your Subscription is valid till the end of billing cycle - {{currentSubscriptionPlan?.subscription?.endDate|date:'dd MMM yyyy'}}.
                </div>
              </div>
              <div class="terms-list">
                <div class="check-icon"><i class="si-check"></i></div>
                <div>
                  Post billing cycle your app will not respond to the end users
                </div>
              </div>
              <div class="terms-list">
                <div class="check-icon"><i class="si-check"></i></div>
                <div>
                  However, you will have access to your app for 15 more days after cancellantion to either reactive or take a backup of your application. After 15 days your app will be permanently deleted.
                </div>
              </div>
            </div>
            <div class="reason-header">What is the reason you want to cancel?</div>

            <div class="reason-check-list">
              <div class="group-checkbox">
                <div class="kr-sg-checkbox d-block" *ngFor="let data of cancellationCheckboxText;let i=index">
                  <input [id]="i" class="checkbox-custom cancel-checkbox" type="checkbox" (change)="data.selected=!data.selected">
                  <label [for]="i" class="checkbox-custom-label">{{data?.name}}</label>
                </div>
              </div>
            </div>

            <div class="reason-comment">
              <div class="kr-sg-input-text-area">
                <div class="label-text">{{"plan.comments"| translate}}</div>
                <textarea placeholder="Start typing here" id="cancel_comment_text" class="input-text"></textarea>
              </div>
            </div>
           </section>
          </div>
        </div>
    </div>
  </perfect-scrollbar>
  <div class="modal-footer text-right">
    <button class="kr-sg-button-primary btn_lg" [disabled]="btnLoader"><span class="loader-spin-inside-btn" *ngIf="btnLoader"></span>{{"plan.done"| translate}}</button>
  </div>
</kr-modal>
  <!-- View plan Modal -->
  <div class="modal fade" id="viewPlanModal">
    <div class="modal-dialog single-plan">
      <div class="modal-content">
        <!-- Modal body -->
        <div class="modal-body">
          <div class="plan-tile-block" *ngFor="let plan of plans?.filterPlansData" [ngClass]="{'d-none':plan?.name!==currentSubscriptionPlan?.subscription?.planName}">
            <div class="plan-type-block">
              <div class="plan-img"><img src="assets/images/pricing-plan/pricing-plan-{{plan?.name|lowercase}}.svg" /></div>
              <div class="plan-details">
                <div class="plan-type">
                  <div class="plan-name">{{plan?.name}}</div>
                  <div class="plan-current-status">Current Plan</div>
                </div>
                <div class="plan-cost-details">
                  <div class="plan-cost" [ngClass]="{'d-none':(currentSubscriptionPlan?.subscription?.planName|lowercase)==='enterprise'}">${{currentSubscriptionPlan?.subscription?.planAmount}} <span class="plan-duration-type">{{(plan?.name|lowercase)!=='free'?'/ ':''}}{{(plan?.name|lowercase)==='free'?'Forever':currentSubscriptionPlan?.subscription?.billingUnit}}</span></div>
                  <div class="plan-cost" [ngClass]="{'d-none':['free','standard'].includes(currentSubscriptionPlan?.subscription?.planName|lowercase)}">Custom Plans</div>
                </div>
              </div>
              <span class="plan-close" data-dismiss="modal"><i class="si-close"></i></span>
            </div>
            <div class="plan-tag-line">
              <div>{{plan?.description}}</div>
            </div>
            <div class="plan-upgrade-block" [ngClass]="{'d-none':((currentSubscriptionPlan?.subscription?.planName|lowercase)==='enterprise')}">
              <button class="btn" (click)="selectModal('choose_plan')">Upgrade Plan</button>
            </div>
            <div class="plan-features-block">
              <perfect-scrollbar class="paln-overflow-scroll">
                <div class="plan-feature-desc" [ngClass]="{'font-weight-bold':['standard','free'].includes(plan?.name|lowercase)}"><span class="icon-si"><i class="si-green-check"></i></span>{{(plan?.name|lowercase)==='enterprise'?plan?.featureAccess?.ingestDocs?.displayText:plan?.featureAccess?.ingestDocs?.fullDisplayText}} <span class="plan-records" *ngIf="['standard','free'].includes(plan?.name|lowercase)">records</span> </div>
                <div class="plan-feature-desc" [ngClass]="{'font-weight-bold':['standard','free'].includes(plan?.name|lowercase)}"><span class="icon-si"><i class="si-green-check"></i></span> {{(plan?.name|lowercase)==='enterprise'?plan?.featureAccess?.searchQueries?.displayText:plan?.featureAccess?.searchQueries?.fullDisplayText}} <span class="plan-records" *ngIf="['standard','free'].includes(plan?.name|lowercase)">queries/month</span> </div>
                <div class="plan-sub-features">
                  <div class="plan-sub-feature-hding">Features Includes</div>
                  <ng-container *ngFor="let feature of plan?.featureData|slice:0:featureLimit">
                    <div class="plan-feature-desc" *ngIf="feature?.displayOnBanner"><span class="icon-si"><i class="si-green-check"></i></span> {{(feature?.name)}} </div>
                  </ng-container>
                  <div class="show-more" [ngClass]="{'d-none':(featureLimit!==6||['standard','enterprise'].includes(currentSubscriptionPlan?.subscription?.planName|lowercase))}" (click)="featureLimit=(plan?.featureData?.length);"><span class="icon-si"><i class="si-ellipsis-horizontal"></i></span> Show 10  more features </div>
                  <div class="plan-sub-feature-hding"><strong>{{(plan?.name|lowercase)==='free'?'Self-Service Support':'Support'}}</strong></div>
                  <div class="plan-feature-desc" *ngIf="(plan?.name|lowercase)==='free'"><span class="icon-si"><i class="si-green-check"></i></span>Kore.ai Community</div>
                  <div class="plan-feature-desc" *ngIf="(plan?.name|lowercase)==='free'"><span class="icon-si"><i class="si-green-check"></i></span>Kore.ai Academy</div>
                  <div class="plan-feature-desc" *ngIf="['standard','enterprise'].includes(plan?.name|lowercase)"><span class="icon-si"><i class="si-green-check"></i></span>{{plan?.name}} support upgrade option</div>
                </div>
              </perfect-scrollbar>
            </div>
          </div>
        </div>
        <!-- Modal body -->
      </div>
    </div>
  </div>

  <app-upgrade-plan #plans (updateBanner)="showBanner($event)"></app-upgrade-plan>
